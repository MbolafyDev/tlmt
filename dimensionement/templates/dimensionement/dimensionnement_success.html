{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-3">Dimensionnement enregistr√© ‚úÖ</h2>

  <div class="mb-3">
    <p><b>Client :</b> {{ demande.nom }} ‚Äî {{ demande.email }}{% if demande.telephone %} ‚Äî {{ demande.telephone }}{% endif %}</p>
    <p class="mb-1"><b>√ânergie journali√®re :</b> {{ demande.energie_journaliere|floatformat:2 }} Wh/j</p>
    <p class="mb-1"><b>Tension syst√®me :</b> {{ demande.tension_systeme|floatformat:0 }} VDC</p>
    <p class="mb-1"><b>Puissance onduleur :</b> {{ demande.puissance_onduleur|floatformat:2 }} VA</p>
  </div>

  <div class="mb-3">
    <h5>Propositions de panneaux</h5>
    <ul>
      {% for p in propositions_pv %}
        <li>{{ p.w }}W ‚Üí {{ p.qty }} √ó ({{ p.w }}W)</li>
      {% endfor %}
    </ul>
  </div>

  <div class="mb-3">
    <h5>Propositions de batteries</h5>
    <ul>
      {% for b in propositions_batt %}
        <li>{{ b.ah }}Ah ‚Üí {{ b.qty }} √ó ({{ b.ah }}Ah)</li>
      {% endfor %}
    </ul>
  </div>

  <div class="d-flex gap-2">
    {% if demande.pdf %}
    <button class="btn btn-primary" onclick="telechargerPDF('{% url 'telecharger_pdf' demande.id %}', 'dimensionnement_{{ demande.id }}.pdf')">
      ‚¨áÔ∏è T√©l√©charger le PDF
    </button>

      <a class="btn btn-outline-secondary" href="{% url 'voir_pdf' demande.id %}" target="_blank">üëÅÔ∏è Voir en ligne</a>
    {% else %}
      <div class="alert alert-warning">Le PDF n‚Äôest pas disponible.</div>
    {% endif %}
    <a class="btn btn-link" href="{% url 'demande_dimensionnement' %}">‚Üê Nouvelle demande</a>
  </div>
</div>
{% if demande.pdf %}
  <script>
    async function telechargerPDF(url, filename) {
      const response = await fetch(url);
      const blob = await response.blob();
      const link = document.createElement("a");
      link.href = window.URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }
  </script>
{% endif %}
{% endblock %}
