{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-3">Demande de dimensionnement photovoltaïque</h2>

  <form method="post" action="{% url 'demande_dimensionnement' %}">
    {% csrf_token %}

    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Nom *</label>
        <input type="text" name="nom" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Email *</label>
        <input type="email" name="email" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Téléphone</label>
        <input type="text" name="telephone" class="form-control">
      </div>

      <div class="col-md-4">
        <label class="form-label">Jours d’autonomie *</label>
        <input type="number" name="jours_autonomie" class="form-control" min="1" step="1" value="3" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Irradiation (kWh/m².j) *</label>
        <input type="number" name="irradiation" class="form-control" step="0.01" min="0" value="2.4" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Coefficient K (rendement) *</label>
        <input type="number" name="rendement_k" class="form-control" step="0.01" min="0" max="1" value="0.65" required>
      </div>
    </div>

    <hr class="my-4">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Appareils (saisies numériques)</h5>
      <div class="d-flex flex-column flex-sm-row gap-2 w-50 w-sm-auto">
        <button type="button" id="btnAddRow" class="btn btn-sm btn-primary w-100 w-sm-auto">+ Ajouter une ligne</button>
        <button type="button" id="btnClearRows" class="btn btn-sm btn-outline-danger w-100 w-sm-auto">Effacer tout</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered align-middle mb-0">
        <thead>
          <tr class="text-center">
            <th style="width: 40%;">Nom (facultatif)</th>
            <th style="width: 20%;">Puissance (W) *</th>
            <th style="width: 20%;">Durée (h/j) *</th>
            <th style="width: 15%;">Quantité *</th>
            <th style="width: 5%;">—</th>
          </tr>
        </thead>
        <tbody id="appareilRows">
          <tr>
            <td><input type="text" class="form-control" name="noms_appareil[]" placeholder="Ex: TV, Lampe…"></td>
            <td><input type="number" class="form-control" name="puissances[]" step="0.1" min="0" required></td>
            <td><input type="number" class="form-control" name="durees[]" step="0.1" min="0" required></td>
            <td><input type="number" class="form-control" name="quantites[]" step="1" min="1" value="1" required></td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-outline-secondary btnRemoveRow" title="Supprimer la ligne">×</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <input type="hidden" name="appareils" value="">

    <div class="mt-4">
      <button type="submit" class="btn btn-success">Calculer & enregistrer le PDF</button>
    </div>
  </form>
</div>

<script>
(function(){
  const tbody = document.getElementById('appareilRows');
  const btnAdd = document.getElementById('btnAddRow');
  const btnClear = document.getElementById('btnClearRows');

  function makeRow(){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" class="form-control" name="noms_appareil[]" placeholder="Ex: Réfrigérateur..."></td>
      <td><input type="number" class="form-control" name="puissances[]" step="0.1" min="0" required></td>
      <td><input type="number" class="form-control" name="durees[]" step="0.1" min="0" required></td>
      <td><input type="number" class="form-control" name="quantites[]" step="1" min="1" value="1" required></td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-outline-secondary btnRemoveRow" title="Supprimer la ligne">×</button>
      </td>
    `;
    return tr;
  }

  btnAdd.addEventListener('click', () => {
    tbody.appendChild(makeRow());
  });

  btnClear.addEventListener('click', () => {
    tbody.innerHTML = '';
    tbody.appendChild(makeRow());
  });

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.btnRemoveRow');
    if (!btn) return;
    const tr = btn.closest('tr');
    if (tr && tbody.rows.length > 1) tr.remove();
  });
})();
</script>
{% endblock %}
