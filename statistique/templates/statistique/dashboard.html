{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
  <h1 class="dashboard-title text-center mb-4">üìä Tableau de bord</h1>

  <!-- ====== CARTES DE STATISTIQUES ====== -->
  <div class="dashboard-cards">
    <div class="card dash-card">
      <div class="card-icon bg-warning"><i class="fas fa-shopping-cart"></i></div>
      <h3>Total Commandes</h3>
      <p>{{ total_commandes }}</p>
    </div>

    <div class="card dash-card">
      <div class="card-icon bg-primary"><i class="fas fa-money-bill-wave"></i></div>
      <h3>Total Ventes (Ar)</h3>
      <p>{{ total_ventes }}</p>
    </div>

    <div class="card dash-card">
      <div class="card-icon bg-success"><i class="fas fa-concierge-bell"></i></div>
      <h3>Total Services</h3>
      <p>{{ total_services }}</p>
    </div>

    <div class="card dash-card">
      <div class="card-icon bg-dark"><i class="fas fa-users"></i></div>
      <h3>Total Utilisateurs</h3>
      <p>{{ total_users }}</p>
    </div>

    <div class="card dash-card">
      <div class="card-icon bg-danger"><i class="fas fa-envelope"></i></div>
      <h3>Total Messages</h3>
      <p>{{ total_messages }}</p>
    </div>

    <div class="card dash-card">
      <div class="card-icon bg-info"><i class="fas fa-solar-panel"></i></div>
      <h3>Total Demandes de Dimensionnement</h3>
      <p>{{ total_dimensionnements }}</p>
    </div>
  </div>

  <hr class="divider">

  <!-- ====== GRAPHIQUES ====== -->
  <div class="charts-container">
    <!-- COMMANDES -->
    <div class="chart-box"><h2>Commandes par mode</h2><canvas id="chartCommandesMode"></canvas></div>
    <div class="chart-box"><h2>Commandes par jour</h2><canvas id="chartCommandesJour"></canvas></div>
    <div class="chart-box"><h2>Commandes par mois</h2><canvas id="chartCommandesMois"></canvas></div>
    <div class="chart-box"><h2>Commandes par ann√©e</h2><canvas id="chartCommandesAnnee"></canvas></div>

    <!-- SERVICES -->
    <div class="chart-box"><h2>Services par statut</h2><canvas id="chartServices"></canvas></div>
    <div class="chart-box"><h2>Services par jour</h2><canvas id="chartServicesJour"></canvas></div>
    <div class="chart-box"><h2>Services par mois</h2><canvas id="chartServicesMois"></canvas></div>
    <div class="chart-box"><h2>Services par ann√©e</h2><canvas id="chartServicesAnnee"></canvas></div>

    <!-- UTILISATEURS -->
    <div class="chart-box"><h2>Connexions utilisateurs par jour</h2><canvas id="chartUsersJour"></canvas></div>
    <div class="chart-box"><h2>Connexions utilisateurs par mois</h2><canvas id="chartUsersMois"></canvas></div>
    <div class="chart-box"><h2>Connexions utilisateurs par ann√©e</h2><canvas id="chartUsersAnnee"></canvas></div>

    <!-- MESSAGES -->
    <div class="chart-box"><h2>Messages par jour</h2><canvas id="chartMessagesJour"></canvas></div>
    <div class="chart-box"><h2>Messages par mois</h2><canvas id="chartMessagesMois"></canvas></div>
    <div class="chart-box"><h2>Messages par ann√©e</h2><canvas id="chartMessagesAnnee"></canvas></div>

    <!-- DEMANDES DE DIMENSIONNEMENT -->
    <div class="chart-box"><h2>Demandes de dimensionnement par mois</h2><canvas id="chartDimensionnementMois"></canvas></div>
  </div>
</div>

<!-- ====== CHART.JS ====== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ===== PIE COMMANDES PAR MODE =====
  const commandesMode = {{ commandes_par_mode|safe }};
  new Chart(document.getElementById('chartCommandesMode'), {
    type:'pie',
    data:{
      labels:commandesMode.map(c=>c.mode_paiement),
      datasets:[{
        data:commandesMode.map(c=>c.total),
        backgroundColor:['#ffc107','#0d1b2a','#36a2eb','#4bc0c0','#9b59b6']
      }]
    },
    options:{plugins:{legend:{position:'bottom'}}}
  });

  // ===== FONCTION G√âN√âRIQUE =====
  function createLineChart(canvasId, data, label, color='#0d1b2a', type='day'){
    const labels = data.map(d=>{
      if(type==='day') return d.day;
      if(type==='month') return d.month;
      if(type==='year') return d.year;
      return '';
    });
    const counts = data.map(d=>d.count);
    new Chart(document.getElementById(canvasId), {
      type:'line',
      data:{
        labels:labels,
        datasets:[{
          label:label,
          data:counts,
          borderColor:color,
          backgroundColor:color+'33',
          fill:true,
          tension:0.3
        }]
      },
      options:{
        scales:{y:{beginAtZero:true}},
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  // COMMANDES
  createLineChart('chartCommandesJour', {{ commandes_par_jour|safe }}, 'Commandes par jour','blue','day');
  createLineChart('chartCommandesMois', {{ commandes_par_mois|safe }}, 'Commandes par mois','blue','month');
  createLineChart('chartCommandesAnnee', {{ commandes_par_annee|safe }}, 'Commandes par ann√©e','blue','year');

  // SERVICES
  createLineChart('chartServicesJour', {{ services_par_jour|safe }}, 'Services par jour','#f39c12','day');
  createLineChart('chartServicesMois', {{ services_par_mois|safe }}, 'Services par mois','#f39c12','month');
  createLineChart('chartServicesAnnee', {{ services_par_annee|safe }}, 'Services par ann√©e','#f39c12','year');

  // UTILISATEURS
  createLineChart('chartUsersJour', {{ logins_par_jour|safe }}, 'Connexions par jour','#2ecc71','day');
  createLineChart('chartUsersMois', {{ logins_par_mois|safe }}, 'Connexions par mois','#2ecc71','month');
  createLineChart('chartUsersAnnee', {{ logins_par_annee|safe }}, 'Connexions par ann√©e','#2ecc71','year');

  // MESSAGES
  createLineChart('chartMessagesJour', {{ messages_par_jour|safe }}, 'Messages par jour','#e74c3c','day');
  createLineChart('chartMessagesMois', {{ messages_par_mois|safe }}, 'Messages par mois','#e74c3c','month');
  createLineChart('chartMessagesAnnee', {{ messages_par_annee|safe }}, 'Messages par ann√©e','#e74c3c','year');

  // DEMANDES DE DIMENSIONNEMENT
  createLineChart('chartDimensionnementMois', {{ dimensionnements_par_mois|safe }}, 'Demandes de dimensionnement par mois','#9b59b6','month');

  // SERVICES STATUT BAR
  new Chart(document.getElementById('chartServices'), {
    type:'bar',
    data:{
      labels:['Planifi√©','En cours','Termin√©'],
      datasets:[{
        label:'Services',
        data:[{{ services_planifie }},{{ services_en_cours }},{{ services_termine }}],
        backgroundColor:['#f39c12','#3498db','#2ecc71']
      }]
    },
    options:{
      scales:{y:{beginAtZero:true}},
      plugins:{legend:{display:false}}
    }
  });
</script>

<!-- ====== STYLES ====== -->
<style>
.dashboard-container{ max-width:1300px;margin:40px auto;padding:20px;background:#f9fafc;border-radius:15px; }
.dashboard-title{ font-size:2rem;font-weight:700;color:#0d1b2a;text-align:center;margin-bottom:1.5rem; }
.dashboard-cards{ display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-bottom:30px; }
.dash-card{ flex:1 1 280px;max-width:300px;padding:20px 15px;background:#fff;border-radius:50px;box-shadow:0 4px 20px rgba(0,0,0,0.08);text-align:center;transition:0.3s; }
.dash-card:hover{ transform:translateY(-5px); box-shadow:0 8px 25px rgba(0,0,0,0.12); }
.dash-card h3{ color:#0d1b2a;font-weight:600;margin-top:8px;font-size:1.1rem; }
.dash-card p{ font-size:1.5rem;font-weight:bold;color:#1a1a2e;margin-top:5px; }
.card-icon{ font-size:1rem;width:28px;height:28px;line-height:28px;border-radius:50%;color:#fff;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;}
.bg-warning{background-color:#ffc107;color:#0d1b2a;}
.bg-primary{background-color:#0d1b2a;}
.bg-success{background-color:#2ecc71;}
.bg-dark{background-color:#2d3436;}
.bg-danger{background-color:#e74c3c;}
.bg-info{background-color:#36a2eb;}
.divider{border:0;height:1px;background:#e0e0e0;margin:2rem 0;}
.charts-container{ display:grid; grid-template-columns:repeat(auto-fit,minmax(380px,1fr)); gap:20px;}
.chart-box{ background:#fff;padding:1rem 1.5rem;border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,0.08);}
.chart-box h2{ font-size:1.2rem;color:#0d1b2a;margin-bottom:1rem;text-align:center;}
canvas{ width:100%; height:300px !important; }
</style>
{% endblock %}
