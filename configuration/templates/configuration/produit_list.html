{% extends "base.html" %}

{% block title %}Gestion des produits - Zara Store{% endblock %}

{% block content %}
<style>
  :root {
    --primary-yellow: #ffcc00;
    --primary-blue: #1a2b4c;
    --bg-light: #f8f9fb;
    --text-dark: #333;
    --radius: 12px;
  }

  body {
    background-color: var(--bg-light);
    color: var(--text-dark);
    font-family: 'Poppins', sans-serif;
  }

  h2 {
    color: var(--primary-blue);
    font-weight: 700;
    margin-bottom: 25px;
  }

  .card {
    background: #fff;
    border-radius: var(--radius);
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
  }

  .card:hover {
    transform: translateY(-3px);
  }

  .img-card {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: var(--radius);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  .card-title {
    font-weight: 600;
    font-size: 1rem;
    text-align: center;
    margin-bottom: 8px;
    line-height: 1.2;
  }

  .card-footer .btn {
    border-radius: var(--radius);
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-outline-primary {
    border-color: var(--primary-blue);
    color: var(--primary-blue);
  }

  .btn-outline-primary:hover {
    background-color: var(--primary-yellow);
    color: var(--primary-blue);
    border-color: var(--primary-yellow);
  }

  .btn-outline-secondary {
    border-color: var(--primary-blue);
    color: var(--primary-blue);
  }

  .btn-outline-secondary:hover {
    background-color: var(--primary-yellow);
    color: var(--primary-blue);
    border-color: var(--primary-yellow);
  }

  .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
  }

  .btn-outline-danger:hover {
    background-color: #dc3545;
    color: #fff;
  }

  .badge {
    font-size: 0.8rem;
    text-transform: uppercase;
  }

  .d-flex.gap-2 {
    flex-wrap: wrap;
    gap: 10px;
  }

  @media (max-width: 576px) {
    .d-flex.gap-2 {
      flex-direction: column;
    }
    .btn {
      width: 100%;
    }
  }
</style>

<div class="container mt-4 mb-5">
  <h2>Gestion des produits</h2>
  <a href="{% url 'produit_add' %}" class="btn btn-primary mb-3">Ajouter un produit</a>

  <div class="row">
    {% for produit in produits %}
      <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
        <div class="card h-100 d-flex flex-column position-relative">

          <!-- Badge actif/inactif -->
          <span class="badge position-absolute top-0 end-0 m-2
            {% if produit.is_active %}bg-success{% else %}bg-secondary{% endif %}">
            {% if produit.is_active %}Actif{% else %}Inactif{% endif %}
          </span>

          <!-- Image -->
          <div class="p-3 text-center">
            {% if produit.images.all %}
              <img src="{{ produit.images.first.image.url }}" class="img-card mx-auto" alt="{{ produit.nom }}">
            {% else %}
              <img src="https://via.placeholder.com/150?text=Pas+d'image" class="img-card mx-auto" alt="No image">
            {% endif %}
          </div>

          <!-- Détails -->
          <div class="d-flex flex-column flex-grow-1">
            <div class="card-body py-2">
              <h5 class="card-title">{{ produit.nom }}</h5>
              <p class="card-text mb-1">{{ produit.description_courte|truncatechars:60 }}</p>
              <p class="mb-0"><strong>Prix :</strong> {{ produit.prix }} €</p>
              <p class="mb-0"><strong>Catégorie :</strong> {{ produit.categorie.nom|default:"—" }}</p>
            </div>

            <div class="card-footer mt-auto d-flex justify-content-center gap-2">
              <!-- Voir détails modal -->
              <button type="button"
                      class="btn btn-outline-secondary btn-view"
                      data-url="{% url 'produit_detail' produit.id %}"
                      title="Voir les détails">
                <i class="fa fa-eye"></i>
              </button>

              <!-- Modifier -->
              <a href="{% url 'produit_edit' produit.id %}"
                 class="btn btn-outline-primary"
                 title="Modifier">
                <i class="fa fa-pen"></i>
              </a>

              <!-- Supprimer -->
              <a href="{% url 'produit_delete' produit.id %}"
                 class="btn btn-outline-danger"
                 onclick="return confirm('Supprimer ce produit ?')"
                 title="Supprimer">
                <i class="fa fa-trash"></i>
              </a>
            </div>
          </div>

        </div>
      </div>
    {% empty %}
      <p class="text-center">Aucun produit disponible.</p>
    {% endfor %}
  </div>

  {% if is_paginated %}
    {% include "includes/paginator.html" %}
  {% endif %}
</div>

<!-- Modal détails produit -->
<div class="modal fade" id="produitDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Détails du produit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body text-center py-5 text-muted">
        Chargement…
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const modalEl = document.getElementById('produitDetailModal');
  const bsModal = new bootstrap.Modal(modalEl);

  document.querySelectorAll(".btn-view").forEach(btn => {
    btn.addEventListener("click", async function() {
      const url = btn.dataset.url;
      const modalContent = modalEl.querySelector('.modal-content');
      modalContent.innerHTML = `
        <div class="modal-header">
          <h5 class="modal-title">Détails du produit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body text-center py-5 text-muted">Chargement…</div>
      `;
      try {
        const resp = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
        const html = await resp.text();
        modalContent.innerHTML = html;
      } catch (e) {
        modalContent.querySelector('.modal-body').innerHTML = "<div class='text-danger'>Erreur de chargement.</div>";
      }
      bsModal.show();
    });
  });
});
</script>
{% endblock %}
