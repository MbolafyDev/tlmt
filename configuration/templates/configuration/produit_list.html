{% extends "base.html" %}

{% block content %}
<div class="container mt-4 mb-5">
  <h2>Gestion des produits</h2>
  <a href="{% url 'produit_add' %}" class="btn btn-success mb-3">Ajouter un produit</a>

  <div class="row">
    {% for produit in produits %}
      <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
        <div class="card h-100 d-flex flex-column">

          <!-- Bloc titre + image centrés -->
          <div class="p-3 text-center">
            <h5 class="card-title product-title mb-2">{{ produit.nom }}</h5>

            {% if produit.images.all %}
              <div id="carousel{{ produit.id }}" class="carousel slide img-carousel mx-auto" data-bs-ride="carousel">
                <div class="carousel-inner">
                  {% for img in produit.images.all %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                      <img src="{{ img.image.url }}" class="img-card" alt="{{ produit.nom }}">
                    </div>
                  {% endfor %}
                </div>
                {% if produit.images.count > 1 %}
                  <button class="carousel-control-prev" type="button" data-bs-target="#carousel{{ produit.id }}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Précédent</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#carousel{{ produit.id }}" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Suivant</span>
                  </button>
                {% endif %}
              </div>
            {% else %}
              <img src="https://via.placeholder.com/150?text=Pas+d'image" class="img-card mx-auto" alt="No image">
            {% endif %}
          </div>

          <!-- Bloc détails -->
          <div class="d-flex flex-column flex-grow-1">
            <div class="card-body py-2">
              <p class="card-text mb-2">{{ produit.description_courte }}</p>
              <p class="mb-1"><strong>Prix :</strong> {{ produit.prix }} Ar</p>
              <p class="mb-0"><strong>Réduction :</strong> {{ produit.reduction }}%</p>
            </div>

            <div class="card-footer mt-auto d-flex align-items-center">
              <!-- Voir (modal) -->
              <button type="button"
                      class="btn btn-sm btn-outline-secondary me-2 btn-view"
                      data-url="{% url 'produit_detail' produit.id %}"
                      title="Voir les détails">
                <i class="fa fa-eye"></i>
              </button>

              <!-- Modifier -->
              <a href="{% url 'produit_edit' produit.id %}"
                 class="btn btn-sm btn-outline-primary me-2" title="Modifier">
                 <i class="fa fa-pen"></i>
              </a>

              <!-- Supprimer -->
              <a href="{% url 'produit_delete' produit.id %}"
                 class="btn btn-sm btn-outline-danger"
                 onclick="return confirm('Supprimer ce produit ?')"
                 title="Supprimer">
                 <i class="fa fa-trash"></i>
              </a>
            </div>
          </div>

        </div>
      </div>
    {% empty %}
      <p class="text-center">Aucun produit disponible.</p>
    {% endfor %}
  </div>
</div>

<!-- MODAL global -->
<div class="modal fade" id="produitDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Détails du produit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted">Chargement…</div>
      </div>
    </div>
  </div>
</div>

<style>
  .card { overflow: hidden; }
  .img-card {
    width: 120px; height: 120px; object-fit: cover;
    border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    display: block;
  }
  .img-carousel { width: 120px; }
  .img-carousel .carousel-inner, .img-carousel .carousel-item { width: 120px; }
  .product-title {
    font-size: 1rem; font-weight: 600; line-height: 1.2;
    white-space: normal; word-wrap: break-word; overflow-wrap: anywhere;
    text-align: center;
  }
  .product-title.long-text { font-size: 0.9rem; }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".product-title").forEach(function(el) {
      if (el.textContent.length > 25) { el.classList.add("long-text"); }
    });

    const modalEl = document.getElementById('produitDetailModal');
    const bsModal = new bootstrap.Modal(modalEl);

    document.querySelectorAll(".btn-view").forEach(function(btn) {
      btn.addEventListener("click", async function() {
        const url = btn.getAttribute("data-url");
        const modalContent = modalEl.querySelector('.modal-content');
        modalContent.innerHTML = `
          <div class="modal-header">
            <h5 class="modal-title">Détails du produit</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body"><div class="text-muted">Chargement…</div></div>
        `;
        try {
          const resp = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
          const html = await resp.text();
          modalContent.innerHTML = html; // on injecte le fragment du serveur
        } catch (e) {
          modalContent.querySelector('.modal-body').innerHTML = "<div class='text-danger'>Erreur de chargement.</div>";
        }
        bsModal.show();
      });
    });
  });
</script>
{% endblock %}
