{% extends "base.html" %}
{% load static %}
{% block title %}Boutique{% endblock %}

{% block content %}
<!-- ================= CAROUSEL PRINCIPAL ================= -->
{% include 'includes/carousel.html' %}

<!-- ================= STYLES MODERNES ================= -->
<style>
  #sidebar-filters {
    transition: all 0.3s ease;
  }

  :root {
    --primary-yellow: #ffc107;
    --primary-blue: #0d1b2a;
    --bg-white: #ffffff;
    --bg-light-gray: #f8f9fa;
    --text-dark: #1a1a2e;
    --text-muted: #6c757d;
    --shadow-light: 0 4px 20px rgba(0,0,0,0.08);
    --shadow-hover: 0 8px 25px rgba(0,0,0,0.12);
  }

  body {
    background-color: var(--bg-light-gray);
    color: var(--text-dark);
    font-family: "Poppins", sans-serif;
  }

  h3 {
    font-weight: 700;
    border-left: 4px solid var(--primary-yellow);
    padding-left: 12px;
    margin-bottom: 2rem;
    color: var(--primary-blue);
    font-size: 1.8rem;
  }

  /* ================== CARD SERVICES ================== */
  .service-card {
    border-radius: 16px;
    overflow: hidden;
    background-color: var(--bg-white);
    box-shadow: var(--shadow-light);
    transition: transform 0.3s, box-shadow 0.3s;
    padding: 0;
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  .service-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }
  .service-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-bottom: 3px solid var(--primary-yellow);
  }
  .card-body {
    padding: 1rem 1rem 1.5rem 1rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .card-title {
    color: var(--primary-blue);
    font-weight: 600;
    font-size: 1.1rem;
  }
  .card-text {
    font-size: 0.9rem;
    color: var(--text-muted);
  }
  .card-text a.voir-plus-service {
    color: var(--primary-yellow);
    font-weight: 500;
    text-decoration: none;
  }
  .card-text a.voir-plus-service:hover {
    color: #e0a800;
  }

  .badge {
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.35em 0.6em;
    border-radius: 12px;
  }

  .btn-like, .btn-comment {
    font-size: 0.85rem;
    border-radius: 50px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0.3rem 0.75rem;
    transition: all 0.3s;
  }
  .btn-like {
    border: 1px solid var(--primary-blue);
    color: var(--primary-blue);
  }
  .btn-like:hover {
    background-color: var(--primary-blue);
    color: var(--bg-white);
  }
  .btn-comment {
    border: 1px solid var(--text-muted);
    color: var(--text-muted);
  }
  .btn-comment:hover {
    background-color: var(--text-muted);
    color: var(--bg-white);
  }

  /* ================== CARD PRODUITS ================== */
  .card.text-center {
    border-radius: 16px;
    padding: 0.75rem;
    margin-bottom: 1.5rem;
    background-color: var(--bg-white);
    transition: transform 0.3s, box-shadow 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .card.text-center:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }
  .card.text-center img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 12px;
  }

  /* ================== BOUTONS ================== */
  .btn-success {
    background-color: var(--primary-yellow);
    border-color: var(--primary-yellow);
    color: var(--primary-blue);
    border-radius: 50px;
    font-size: 0.85rem;
    padding: 0.35rem 0.9rem;
  }
  .btn-success:hover {
    background-color: #e0a800;
    border-color: #e0a800;
    color: var(--primary-blue);
  }
  .btn-info {
    background-color: var(--primary-blue);
    border-color: var(--primary-blue);
    color: var(--bg-white);
    border-radius: 50px;
    font-size: 0.85rem;
    padding: 0.35rem 0.9rem;
  }
  .btn-info:hover {
    background-color: #081224;
    border-color: #081224;
  }

  /* ================== MODAL ================== */
  .modal-content {
    border-radius: 16px;
    overflow: hidden;
  }
  .modal-header {
    background-color: var(--primary-yellow);
    border-bottom: none;
  }
  .modal-title {
    color: var(--primary-blue);
    font-weight: 700;
  }

  /* ================== COMMENTAIRES ================== */
  #comments-container {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 5px;
  }
  #comments-container .comment-item {
    display: flex;
    flex-direction: column;
    background-color: var(--bg-white);
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    border-radius: 20px;
    box-shadow: var(--shadow-light);
    position: relative;
  }
  #comments-container .comment-item::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 12px;
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid var(--bg-white);
  }
  #comments-container .comment-item strong {
    color: var(--primary-blue);
    margin-bottom: 0.2rem;
  }

  .comment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 8px;
  }

  .btn-reply {
    background: none;
    border: none;
    color: var(--primary-blue);
    font-size: 0.85rem;
    padding: 0;
    cursor: pointer;
    align-self: flex-end;
    margin-top: 4px;
  }

  .reply-container {
    margin-left: 3rem;
    margin-top: 0.5rem;
    background-color: #f0f2f5;
    padding: 0.5rem 0.75rem;
    border-radius: 18px;
    box-shadow: var(--shadow-light);
  }
  .reply-container strong {
    color: var(--primary-blue);
  }

  .reply-input, #new-comment-input {
    width: 100%;
    border-radius: 50px;
  }
  .reply-input-container {
    display: flex;
    gap: 4px;
    align-items: center;
  }
  .reply-input-container button {
    border-radius: 50%;
    padding: 0.35rem 0.5rem;
  }
  #submit-comment {
    border-radius: 50px;
    padding: 0.35rem 1rem;
  }

  /* ================== SIDEBAR ================== */
  .sidebar {
    background-color: var(--bg-white);
    padding: 1rem;
    border-radius: 16px;
    box-shadow: var(--shadow-light);
    margin-bottom: 1.5rem;
  }
  .sidebar h5 {
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--primary-blue);
  }
  .sidebar label {
    font-weight: 500;
    margin-top: 0.5rem;
  }
  .sidebar input, .sidebar select {
    width: 100%;
    margin-bottom: 1rem;
    padding: 0.4rem;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  /* ================== MOBILE TOGGLE ================== */
  @media (max-width: 767.98px){
    #sidebar-filters {
      display: none;
    }
    .sidebar-toggle {
      margin-bottom: 1rem;
    }
  }
</style>

<!-- ================= SERVICES ================= -->
<section class="container my-5">
  
  <div class="row">
    <!-- ================= SIDEBAR SERVICES + PRODUITS ================= -->
    <div class="d-md-none col-12 mb-3">
      <button class="btn btn-primary w-100 sidebar-toggle" id="toggle-sidebar-btn">
        <i class="fas fa-filter"></i> Filtres
      </button>
    </div>

    <div class="col-md-3">
      {% include 'home/includes/filtre_sidebar.html' %}
    </div>


    <!-- ================= SERVICES CARDS ================= -->
    {% include 'home/includes/services_card.html' %}
  </div>
</section>

<!-- ================= PRODUITS AVEC SIDEBAR ================= -->
<section class="container my-5">
  
  <div class="row">
    <div class="col-md-3 d-none d-md-block">
      <!-- Le filtre est déjà inclus dans sidebar-filters -->
    </div>
    {% include 'home/includes/produit_card.html' %}
  </div>
</section>

<!-- ================= MODALS ================= -->
{% include 'home/includes/service_modal.html' %}

<!-- ================= JS ================= -->
 <script>
document.addEventListener('DOMContentLoaded', function() {
  // ================= TOGGLE SIDEBAR MOBILE =================
  const toggleBtn = document.getElementById('toggle-sidebar-btn');
  const sidebar = document.getElementById('sidebar-filters');
  toggleBtn?.addEventListener('click', function() {
    sidebar.classList.toggle('d-none');
    sidebar.classList.toggle('d-block');
  });

  // ================= AJUSTEMENT PRIX =================
  const prixMin = document.getElementById('prix-min-sidebar');
  const prixMax = document.getElementById('prix-max-sidebar');
  const prixMinVal = document.getElementById('prix-min-val-sidebar');
  const prixMaxVal = document.getElementById('prix-max-val-sidebar');

  prixMin?.addEventListener('input', function() { 
    prixMinVal.innerText = this.value; 
    if(parseInt(this.value) > parseInt(prixMax.value)) prixMax.value = this.value; 
  });
  prixMax?.addEventListener('input', function() { 
    prixMaxVal.innerText = this.value; 
    if(parseInt(this.value) < parseInt(prixMin.value)) prixMin.value = this.value; 
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftokenFromTemplate = '{{ csrf_token }}';
  const csrftoken = (csrftokenFromTemplate && csrftokenFromTemplate !== 'None') ? csrftokenFromTemplate : getCookie('csrftoken');

  const serviceModal = new bootstrap.Modal(document.getElementById('serviceModal'));
  

  // ================= AJOUT AU PANIER =================
  document.querySelectorAll('.btn-add-cart').forEach(button => {
    button.addEventListener('click', function(e){
      e.preventDefault();
      const produitId = this.dataset.id;
      const qtyInput = this.closest('.d-flex').querySelector('.qty-input');
      const quantite = qtyInput ? parseInt(qtyInput.value) : 1;

      fetch("{% url 'ajouter_au_panier' %}", {
        method: "POST",
        credentials: 'same-origin',
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: new URLSearchParams({ 'produit_id': produitId, 'quantite': quantite })
      })
      .then(resp => resp.json())
      .then(data => {
        if(data.success){
          const cartDesktop = document.getElementById('cart-badge');
          const cartMobile = document.getElementById('cart-badge-mobile');
          if(cartDesktop) cartDesktop.textContent = data.total_items;
          if(cartMobile) cartMobile.textContent = data.total_items;
        } else if(data.redirect){
          window.location.href = data.login_url;
        }
      }).catch(err => console.error(err));
    });
  });

  // ================= MODAL VOIR PLUS SERVICE =================
  document.querySelectorAll('.voir-plus-service').forEach(link => {
    link.addEventListener('click', function(e){
      e.preventDefault();
      const serviceId = this.dataset.serviceId;
      const url = "{% url 'voir_plus_service' service_id=0 %}".replace('0', serviceId);
      fetch(url)
        .then(resp => resp.json())
        .then(data => {
          document.querySelector('#serviceModal .modal-content-container').innerHTML = data.html;
          serviceModal.show();
        }).catch(err => console.error(err));
    });
  });

  // ================= LIKE =================
  document.querySelectorAll('.btn-like').forEach(btn => {
    btn.addEventListener('click', function(){
      const serviceId = this.dataset.serviceId;
      fetch("{% url 'like_service' %}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken
        },
        body: new URLSearchParams({'service_id': serviceId})
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.likes_count !== undefined) {
          this.querySelector('.like-count').textContent = data.likes_count;
        }
      }).catch(err => console.error(err));
    });
  });

  // ================= COMMENTAIRES =================
  let currentServiceId = null;

  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function renderComment(comment, container){
    const div = document.createElement('div');
    div.classList.add('comment-item');
    div.dataset.commentId = comment.id;

    const username = escapeHtml(comment.username || 'Utilisateur');
    const content = escapeHtml(comment.content || '');
    const avatar = comment.avatar_url || '{% static "images/default.png" %}';

    div.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px;">
        <img src="${avatar}" class="comment-avatar">
        <div>
          <strong>${username}</strong> : <span>${content}</span>
          <button class="btn-reply" data-username="${username}" data-comment-id="${comment.id}">Répondre</button>
        </div>
      </div>
    `;
    container.appendChild(div);

    if(comment.replies && comment.replies.length){
      comment.replies.forEach(rep => {
        const replyDiv = document.createElement('div');
        replyDiv.classList.add('reply-container');
        const ruser = escapeHtml(rep.username || 'Utilisateur');
        const rcontent = escapeHtml(rep.content || '');
        const ravatar = rep.avatar_url || '{% static "images/default.png" %}';
        replyDiv.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px;">
            <img src="${ravatar}" class="comment-avatar" style="width:30px;height:30px;">
            <div><strong>${ruser}</strong> : ${rcontent}</div>
          </div>
        `;
        div.appendChild(replyDiv);
      });
    }
  }

  document.querySelectorAll('.btn-comment').forEach(btn => {
    btn.addEventListener('click', function(){
      currentServiceId = this.dataset.serviceId;
      const url = "{% url 'get_comments_service' service_id=0 %}".replace('0', currentServiceId);
      fetch(url)
        .then(resp => resp.json())
        .then(data => {
          const container = document.getElementById('comments-container');
          container.innerHTML = '';
          if(!data.comments || data.comments.length === 0){
            container.innerHTML = '<p>Aucun commentaire pour le moment.</p>';
          } else {
            data.comments.forEach(comment => renderComment(comment, container));
          }
          const input = document.getElementById('new-comment-input');
          if(input) input.value = '';
        }).catch(err => console.error(err));
    });
  });

  // ================= NOUVEAU COMMENTAIRE =================
  const submitBtn = document.getElementById('submit-comment');
  if(submitBtn){
    submitBtn.addEventListener('click', function(){
      const contentInput = document.getElementById('new-comment-input');
      const content = contentInput ? contentInput.value.trim() : '';
      if(!content) return alert('Le commentaire ne peut pas être vide.');

      fetch("{% url 'comment_service' %}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken
        },
        body: new URLSearchParams({ 'service_id': currentServiceId, 'content': content })
      })
      .then(resp => resp.json())
      .then(data => {
        if(data.success){
          const container = document.getElementById('comments-container');
          renderComment({ id: data.comment_id, username: data.username, content: data.content, replies: [], avatar_url: data.avatar_url }, container);
          if(contentInput) contentInput.value = '';
          const countSpan = document.querySelector(`.btn-comment[data-service-id="${currentServiceId}"] .comment-count`);
          if(countSpan && data.comments_count !== undefined) countSpan.textContent = data.comments_count;
        } else {
          alert(data.error || 'Erreur lors de l\'envoi du commentaire.');
        }
      }).catch(err => console.error(err));
    });
  }

  // ================= RÉPONSES AVEC BOUTON SEND =================
  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('btn-reply')){
      const commentId = e.target.dataset.commentId;
      const username = e.target.dataset.username;

      const prevInputContainer = e.target.parentNode.querySelector('.reply-input-container');
      if(prevInputContainer) prevInputContainer.remove();

      const containerDiv = document.createElement('div');
      containerDiv.className = 'reply-input-container mt-2';

      const replyInput = document.createElement('input');
      replyInput.className = 'form-control reply-input';
      replyInput.placeholder = `Répondre à ${username}...`;

      const sendBtn = document.createElement('button');
      sendBtn.className = 'btn btn-primary';
      sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';

      containerDiv.appendChild(replyInput);
      containerDiv.appendChild(sendBtn);
      e.target.parentNode.appendChild(containerDiv);

      function sendReply(){
        const content = replyInput.value.trim();
        if(!content) return alert('Le message ne peut pas être vide.');

        fetch("{% url 'reply_comment_service' %}", {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
          },
          body: new URLSearchParams({ 'comment_id': commentId, 'content': content })
        })
        .then(resp => resp.json())
        .then(data => {
          if(data.success){
            const newReply = document.createElement('div');
            newReply.classList.add('reply-container');
            const avatar = data.avatar_url || '{% static "images/default.png" %}';
            newReply.innerHTML = `
              <div style="display:flex; align-items:center; gap:8px;">
                <img src="${avatar}" class="comment-avatar" style="width:30px;height:30px;">
                <div><strong>${escapeHtml(data.username)}</strong> : ${escapeHtml(data.content)}</div>
              </div>
            `;
            containerDiv.parentNode.appendChild(newReply);
            containerDiv.remove();

            if(data.comments_count !== undefined && currentServiceId){
              const countSpan = document.querySelector(`.btn-comment[data-service-id="${currentServiceId}"] .comment-count`);
              if(countSpan) countSpan.textContent = data.comments_count;
            }
          } else {
            alert(data.error || 'Erreur lors de l\'envoi de la réponse.');
          }
        }).catch(err => console.error(err));
      }

      sendBtn.addEventListener('click', sendReply);
      replyInput.addEventListener('keypress', function(ev){
        if(ev.key === 'Enter' && window.innerWidth > 576){
          sendReply();
        }
      });
    }
  });
});
</script>


{% endblock %}