{% extends "base.html" %}
{% load static %}

{% block title %}Home Page{% endblock %}

{% block content %}

<!-- ================= CAROUSEL PRINCIPAL ================= -->
{% include 'includes/carousel.html' %}

<!-- ================= SERVICES ================= -->
<section class="container my-5">
  <h3 class="mb-3">Nos Services & Travaux Réalisés</h3>
  <div class="row g-4">
    {% for service in services %}
    <div class="col-sm-6 col-md-4 col-lg-3">
      <!-- HAUTEUR AUGMENTÉE à 500px pour laisser de la place aux icônes -->
      <div class="card shadow-sm position-relative service-card" style="height: 500px; overflow: hidden;">

        <!-- Badge statut -->
        {% with statut_display=service.get_statut_display %}
        {% if statut_display %}
          {% if statut_display == 'Planifié' %}
            <span class="badge bg-warning position-absolute top-0 end-0 m-2" style="z-index: 10;">{{ statut_display }}</span>
          {% elif statut_display == 'En cours' %}
            <span class="badge bg-secondary position-absolute top-0 end-0 m-2" style="z-index: 10;">{{ statut_display }}</span>
          {% elif statut_display == 'Terminé' %}
            <span class="badge bg-success position-absolute top-0 end-0 m-2" style="z-index: 10;">{{ statut_display }}</span>
          {% endif %}
        {% endif %}
        {% endwith %}

        <!-- Image service -->
        <div class="service-img-wrapper" style="height: 200px; overflow: hidden;">
          {% if service.images.exists %}
            <img src="{{ service.images.first.image.url }}" class="w-100 h-100" style="object-fit: contain;" alt="{{ service.titre }}">
          {% else %}
            <img src="{% static 'images/default.png' %}" class="w-100 h-100" style="object-fit: contain;" alt="{{ service.titre }}">
          {% endif %}
        </div>

        <!-- Contenu card -->
        <!-- HAUTEUR AJUSTÉE : calc(100% - 200px) -> calc(100% - 200px) pour laisser plus de place -->
        <div class="card-body d-flex flex-column" style="height: calc(100% - 200px);">
          <h5 class="card-title text-info">{{ service.titre }}</h5>

          <!-- Aperçu description en haut -->
          <p class="card-text flex-grow-1">
            {% if service.description %}
              {% if service.description|length > 50 %}
                {{ service.description|slice:":50" }}...
              {% else %}
                {{ service.description }}
              {% endif %}
              <a href="#" class="text-primary voir-plus-service" data-service-id="{{ service.id }}" style="text-decoration: underline;">Voir plus</a>
            {% else %}
              Aucune description disponible.
            {% endif %}
          </p>

          <!-- Infos supplémentaires -->
          <p class="mb-1"><strong>Lieu :</strong> {{ service.lieu }}</p>
          <p class="mb-1"><strong>Durée :</strong> {{ service.duree }}</p>
          {% if service.date_debut %}<p class="mb-1"><strong>Début :</strong> {{ service.date_debut }}</p>{% endif %}
          {% if service.date_fin %}<p class="mb-1"><strong>Fin :</strong> {{ service.date_fin }}</p>{% endif %}

          <!-- ICÔNES COMMENTAIRE & LIKE -->
          <div class="d-flex justify-content-start align-items-center mt-2">
            <button class="btn btn-sm btn-outline-primary me-2 like-btn" data-service-id="{{ service.id }}">
              <i class="fas fa-thumbs-up"></i> <span class="like-count">{{ service.likes|default:0 }}</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary comment-btn" data-service-id="{{ service.id }}">
              <i class="fas fa-comment"></i> <span class="comment-count">{{ service.comments|default:0 }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<!-- ================= PRODUITS ================= -->
<section class="container my-5">
  <h3 class="mb-3">Produits en Vente</h3>
  <div class="row g-3">
    {% for produit in produits %}
    <div class="col-6 col-md-3">
      <div class="card text-center shadow-sm p-2">
        {% if produit.images.exists %}
        <div id="carouselProduit{{ produit.id }}" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner">
            {% for image in produit.images.all %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <img src="{{ image.image.url }}" class="d-block mx-auto" style="width:50px; height:50px; object-fit:cover;">
            </div>
            {% endfor %}
          </div>
          {% if produit.images.count > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselProduit{{ produit.id }}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselProduit{{ produit.id }}" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
          {% endif %}
        </div>
        {% else %}
        <img src="{% static 'images/default.png' %}" class="mx-auto" style="width:50px; height:50px; object-fit:cover;">
        {% endif %}
        <p class="mt-2 mb-1 fw-bold">{{ produit.nom }}</p>
        <p class="mb-1 text-danger fw-bold">{{ produit.prix }} Ar</p>
        <div class="d-flex justify-content-center align-items-center">
          <input type="number" value="1" min="1" class="form-control form-control-sm me-1 qty-input" style="width:50px;">
          <button class="btn btn-success btn-sm btn-add-cart" data-id="{{ produit.id }}">
            <i class="fas fa-cart-arrow-down"></i>
          </button>
          <a href="{% url 'produit_detail_home' produit_id=produit.id %}" class="btn btn-info btn-sm ms-1">
            <i class="fas fa-eye"></i>
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% include 'includes/paginator.html' %}
</section>

<!-- Modal container pour service -->
<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content-container"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ajouter au panier
    const addButtons = document.querySelectorAll('.btn-add-cart');
    addButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const produitId = this.dataset.id;
            const qtyInput = this.closest('.d-flex').querySelector('.qty-input');
            const quantite = qtyInput ? parseInt(qtyInput.value) : 1;

            fetch("{% url 'ajouter_au_panier' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: new URLSearchParams({
                    'produit_id': produitId,
                    'quantite': quantite
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    const cartBadgeDesktop = document.getElementById('cart-badge');
                    const cartBadgeMobile = document.getElementById('cart-badge-mobile');
                    if(cartBadgeDesktop) cartBadgeDesktop.textContent = data.total_items;
                    if(cartBadgeMobile) cartBadgeMobile.textContent = data.total_items;
                } else if(data.redirect){
                    window.location.href = data.login_url;
                }
            })
            .catch(error => console.error('Erreur AJAX panier:', error));
        });
    });

    // Voir plus service - modal AJAX
    const serviceModal = new bootstrap.Modal(document.getElementById('serviceModal'));
    document.querySelectorAll('.voir-plus-service').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const serviceId = this.dataset.serviceId;
            fetch(`/service/voir-plus/${serviceId}/`)
                .then(resp => resp.json())
                .then(data => {
                    document.querySelector('#serviceModal .modal-content-container').innerHTML = data.html;
                    serviceModal.show();
                })
                .catch(err => console.error("Erreur modal service:", err));
        });
    });

    // Like & Comment buttons (dummy click)
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            let countSpan = this.querySelector('.like-count');
            let count = parseInt(countSpan.textContent);
            countSpan.textContent = count + 1;
            // Ici vous pouvez ajouter fetch AJAX pour sauvegarder le like dans DB
        });
    });

    document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Ici vous pouvez ouvrir un modal de commentaire ou rediriger
            alert('Fonction commentaire pour le service ' + this.dataset.serviceId);
        });
    });
});
</script>

{% endblock %}
