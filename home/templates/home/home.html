{% extends "base.html" %}
{% load static %}
{% block title %}Boutique{% endblock %}

{% block content %}
<!-- ================= CAROUSEL PRINCIPAL ================= -->
{% include 'includes/carousel.html' %}

<!-- ================= STYLES MODERNES ================= -->
<style>
  #sidebar-filters {
    transition: all 0.3s ease;
  }

  :root {
    --primary-yellow: #ffc107;
    --primary-blue: #0d1b2a;
    --bg-white: #ffffff;
    --bg-light-gray: #f8f9fa;
    --text-dark: #1a1a2e;
    --text-muted: #6c757d;
    --shadow-light: 0 4px 20px rgba(0,0,0,0.08);
    --shadow-hover: 0 8px 25px rgba(0,0,0,0.12);
  }

  body {
    background-color: var(--bg-light-gray);
    color: var(--text-dark);
    font-family: "Poppins", sans-serif;
  }

  h3 {
    font-weight: 700;
    border-left: 4px solid var(--primary-yellow);
    padding-left: 12px;
    margin-bottom: 2rem;
    color: var(--primary-blue);
    font-size: 1.8rem;
  }

  /* ================== CARD SERVICES ================== */
  .service-card {
    border-radius: 16px;
    overflow: hidden;
    background-color: var(--bg-white);
    box-shadow: var(--shadow-light);
    transition: transform 0.3s, box-shadow 0.3s;
    padding: 0;
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  .service-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }
  .service-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-bottom: 3px solid var(--primary-yellow);
  }
  .card-body {
    padding: 1rem 1rem 1.5rem 1rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .card-title {
    color: var(--primary-blue);
    font-weight: 600;
    font-size: 1.1rem;
  }
  .card-text {
    font-size: 0.9rem;
    color: var(--text-muted);
  }
  .card-text a.voir-plus-service {
    color: var(--primary-yellow);
    font-weight: 500;
    text-decoration: none;
  }
  .card-text a.voir-plus-service:hover {
    color: #e0a800;
  }

  .badge {
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.35em 0.6em;
    border-radius: 12px;
  }

  .btn-like, .btn-comment {
    font-size: 0.85rem;
    border-radius: 50px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0.3rem 0.75rem;
    transition: all 0.3s;
  }
  .btn-like {
    border: 1px solid var(--primary-blue);
    color: var(--primary-blue);
  }
  .btn-like:hover {
    background-color: var(--primary-blue);
    color: var(--bg-white);
  }
  .btn-comment {
    border: 1px solid var(--text-muted);
    color: var(--text-muted);
  }
  .btn-comment:hover {
    background-color: var(--text-muted);
    color: var(--bg-white);
  }

  /* ================== CARD PRODUITS ================== */
  .card.text-center {
    border-radius: 16px;
    padding: 0.75rem;
    margin-bottom: 1.5rem;
    background-color: var(--bg-white);
    transition: transform 0.3s, box-shadow 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .card.text-center:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }
  .card.text-center img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 12px;
  }

  /* ================== BOUTONS ================== */
  .btn-success {
    background-color: var(--primary-yellow);
    border-color: var(--primary-yellow);
    color: var(--primary-blue);
    border-radius: 50px;
    font-size: 0.85rem;
    padding: 0.35rem 0.9rem;
  }
  .btn-success:hover {
    background-color: #e0a800;
    border-color: #e0a800;
    color: var(--primary-blue);
  }
  .btn-info {
    background-color: var(--primary-blue);
    border-color: var(--primary-blue);
    color: var(--bg-white);
    border-radius: 50px;
    font-size: 0.85rem;
    padding: 0.35rem 0.9rem;
  }
  .btn-info:hover {
    background-color: #081224;
    border-color: #081224;
  }

  /* ================== MODAL ================== */
  .modal-content {
    border-radius: 16px;
    overflow: hidden;
  }
  .modal-header {
    background-color: var(--primary-yellow);
    border-bottom: none;
  }
  .modal-title {
    color: var(--primary-blue);
    font-weight: 700;
  }

  /* ================== COMMENTAIRES ================== */
  #comments-container {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 5px;
  }
  #comments-container .comment-item {
    display: flex;
    flex-direction: column;
    background-color: var(--bg-white);
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    border-radius: 20px;
    box-shadow: var(--shadow-light);
    position: relative;
  }
  #comments-container .comment-item::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 12px;
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid var(--bg-white);
  }
  #comments-container .comment-item strong {
    color: var(--primary-blue);
    margin-bottom: 0.2rem;
  }

  .comment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 8px;
  }

  .btn-reply {
    background: none;
    border: none;
    color: var(--primary-blue);
    font-size: 0.85rem;
    padding: 0;
    cursor: pointer;
    align-self: flex-end;
    margin-top: 4px;
  }

  .reply-container {
    margin-left: 3rem;
    margin-top: 0.5rem;
    background-color: #f0f2f5;
    padding: 0.5rem 0.75rem;
    border-radius: 18px;
    box-shadow: var(--shadow-light);
  }
  .reply-container strong {
    color: var(--primary-blue);
  }

  .reply-input, #new-comment-input {
    width: 100%;
    border-radius: 50px;
  }
  .reply-input-container {
    display: flex;
    gap: 4px;
    align-items: center;
  }
  .reply-input-container button {
    border-radius: 50%;
    padding: 0.35rem 0.5rem;
  }
  #submit-comment {
    border-radius: 50px;
    padding: 0.35rem 1rem;
  }

  /* ================== SIDEBAR ================== */
  .sidebar {
    background-color: var(--bg-white);
    padding: 1rem;
    border-radius: 16px;
    box-shadow: var(--shadow-light);
    margin-bottom: 1.5rem;
  }
  .sidebar h5 {
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--primary-blue);
  }
  .sidebar label {
    font-weight: 500;
    margin-top: 0.5rem;
  }
  .sidebar input, .sidebar select {
    width: 100%;
    margin-bottom: 1rem;
    padding: 0.4rem;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  /* ================== MOBILE TOGGLE ================== */
  @media (max-width: 767.98px){
    #sidebar-filters {
      display: none;
    }
    .sidebar-toggle {
      margin-bottom: 1rem;
    }
  }
</style>

<!-- ================= SERVICES ================= -->
<section class="container my-5">
  
  <div class="row">
    <!-- ================= SIDEBAR SERVICES + PRODUITS ================= -->
    <div class="d-md-none col-12 mb-3">
      <button class="btn btn-primary w-100 sidebar-toggle" id="toggle-sidebar-btn">
        <i class="fas fa-filter"></i> Filtres
      </button>
    </div>

    <div class="col-md-3">
      <div class="sidebar d-none d-md-block" id="sidebar-filters">
        <!-- ================= FILTRE SERVICES ================= -->
        <h5>Filtres Services</h5>
        <form id="service-filter-form-sidebar" method="get">
          <label for="filter-statut-sidebar">Statut :</label>
          <select name="statut" id="filter-statut-sidebar" class="form-select">
            <option value="">Tous</option>
            <option value="planifie" {% if request.GET.statut == "planifie" %}selected{% endif %}>Planifié</option>
            <option value="en_cours" {% if request.GET.statut == "en_cours" %}selected{% endif %}>En cours</option>
            <option value="termine" {% if request.GET.statut == "termine" %}selected{% endif %}>Terminé</option>
          </select>
          <button type="submit" class="btn btn-primary w-100 mt-2">Filtrer</button>
        </form>

        <!-- ================= FILTRE PRODUITS ================= -->
        <h5 class="mt-4">Filtres Produits</h5>
        <form id="filter-form-sidebar" method="get">
          <label>Catégorie</label>
          <select name="categorie" id="filter-categorie-sidebar">
            <option value="">Toutes</option>
            {% for cat in categories_menu %}
              <option value="{{ cat.slug }}" {% if cat.slug == categorie_selected %}selected{% endif %}>{{ cat.nom }}</option>
            {% endfor %}
          </select>

          <label>Prix minimum : <span id="prix-min-val-sidebar">{{ prix_min|default:"0" }}</span> Ar</label>
          <input type="range" name="prix_min" min="0" max="100000" value="{{ prix_min|default:"0" }}" id="prix-min-sidebar" class="form-range">

          <label>Prix maximum : <span id="prix-max-val-sidebar">{{ prix_max|default:"100000" }}</span> Ar</label>
          <input type="range" name="prix_max" min="0" max="100000" value="{{ prix_max|default:"100000" }}" id="prix-max-sidebar" class="form-range">

          <label>Tri</label>
          <select name="tri" id="filter-tri-sidebar">
            <option value="">Derniers ajoutés</option>
            <option value="alpha" {% if tri|default:'' == 'alpha' %}selected{% endif %}>A-Z</option>
          </select>

          <button type="submit" class="btn btn-primary w-100 mt-2">Filtrer</button>
        </form>
      </div>
    </div>

    <!-- ================= SERVICES CARDS ================= -->
    <div class="col-md-9">
      <h3>Nos Services & Travaux Réalisés</h3>
      <div class="row g-4 d-flex align-items-stretch">
        {% for service in services %}
        <div class="col-sm-6 col-md-6 col-lg-4">
          <div class="service-card shadow-sm">
            {% if service.images.exists %}
              <img src="{{ service.images.first.image.url }}" alt="{{ service.titre }}">
            {% else %}
              <img src="{% static 'images/default.png' %}" alt="{{ service.titre }}">
            {% endif %}
            <div class="card-body d-flex flex-column justify-content-between">
              {% with statut_display=service.get_statut_display %}
                {% if statut_display %}
                  {% if statut_display == "Planifié" %}
                    <span class="badge bg-warning">{{ statut_display }}</span>
                  {% elif statut_display == "En cours" %}
                    <span class="badge bg-secondary">{{ statut_display }}</span>
                  {% elif statut_display == "Terminé" %}
                    <span class="badge bg-success">{{ statut_display }}</span>
                  {% endif %}
                {% endif %}
              {% endwith %}
              <h5 class="card-title mt-2">{{ service.titre }}</h5>
              <p class="card-text">
                {% if service.description %}
                  {% if service.description|length > 50 %}
                    {{ service.description|slice:":50" }}...
                  {% else %}
                    {{ service.description }}
                  {% endif %}
                  <a href="#" class="voir-plus-service" data-service-id="{{ service.id }}">Voir plus</a>
                {% else %}
                  Aucune description disponible.
                {% endif %}
              </p>
              {% if user.is_authenticated %}
              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-like btn-sm" data-service-id="{{ service.id }}">
                  <i class="fas fa-thumbs-up"></i>
                  <span class="like-count">{{ service.likes_count }}</span>
                </button>
                <button class="btn btn-comment btn-sm" data-service-id="{{ service.id }}" data-bs-toggle="modal" data-bs-target="#commentModal">
                  <i class="fas fa-comment"></i>
                  <span class="comment-count">{{ service.comments_count }}</span>
                </button>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<!-- ================= PRODUITS AVEC SIDEBAR ================= -->
<section class="container my-5">
  
  <div class="row">
    <div class="col-md-3 d-none d-md-block">
      <!-- Le filtre est déjà inclus dans sidebar-filters -->
    </div>
    <div class="col-md-9">
      <h3>Produits en Vente</h3>
      <div class="row g-3 d-flex align-items-stretch">
        {% for produit in produits %}
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card text-center shadow-sm p-2">
            {% if produit.images.exists %}
              <img src="{{ produit.images.first.image.url }}" alt="{{ produit.nom }}">
            {% else %}
              <img src="{% static 'images/default.png' %}" alt="{{ produit.nom }}">
            {% endif %}
            <p class="mt-2 mb-1 fw-bold">{{ produit.nom }}</p>
            <p class="mb-1 text-danger fw-bold">{{ produit.prix }} Ar</p>
            <div class="d-flex justify-content-center align-items-center gap-1">
              <input type="number" value="1" min="1" class="form-control form-control-sm qty-input" style="width:50px;">
              <button class="btn btn-success btn-sm btn-add-cart" data-id="{{ produit.id }}">
                <i class="fas fa-cart-arrow-down"></i>
              </button>
              <a href="{% url 'produit_detail_home' produit_id=produit.id %}" class="btn btn-info btn-sm">
                <i class="fas fa-eye"></i>
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% include 'includes/paginator.html' %}
    </div>
  </div>
</section>

<!-- ================= MODALS ================= -->
<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content-container"></div>
  </div>
</div>

<div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Commentaires</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="comments-container"></div>
        {% if user.is_authenticated %}
        <div class="mt-3 d-flex gap-2">
          <input type="text" class="form-control" id="new-comment-input" placeholder="Écrire un commentaire...">
          <button class="btn btn-primary" id="submit-comment">Envoyer</button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ================= JS ================= -->
 <script>
document.addEventListener('DOMContentLoaded', function() {
  // ================= TOGGLE SIDEBAR MOBILE =================
  const toggleBtn = document.getElementById('toggle-sidebar-btn');
  const sidebar = document.getElementById('sidebar-filters');
  toggleBtn?.addEventListener('click', function() {
    sidebar.classList.toggle('d-none');
    sidebar.classList.toggle('d-block');
  });

  // ================= AJUSTEMENT PRIX =================
  const prixMin = document.getElementById('prix-min-sidebar');
  const prixMax = document.getElementById('prix-max-sidebar');
  const prixMinVal = document.getElementById('prix-min-val-sidebar');
  const prixMaxVal = document.getElementById('prix-max-val-sidebar');

  prixMin?.addEventListener('input', function() { 
    prixMinVal.innerText = this.value; 
    if(parseInt(this.value) > parseInt(prixMax.value)) prixMax.value = this.value; 
  });
  prixMax?.addEventListener('input', function() { 
    prixMaxVal.innerText = this.value; 
    if(parseInt(this.value) < parseInt(prixMin.value)) prixMin.value = this.value; 
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftokenFromTemplate = '{{ csrf_token }}';
  const csrftoken = (csrftokenFromTemplate && csrftokenFromTemplate !== 'None') ? csrftokenFromTemplate : getCookie('csrftoken');

  const serviceModal = new bootstrap.Modal(document.getElementById('serviceModal'));
  

  // ================= AJOUT AU PANIER =================
  document.querySelectorAll('.btn-add-cart').forEach(button => {
    button.addEventListener('click', function(e){
      e.preventDefault();
      const produitId = this.dataset.id;
      const qtyInput = this.closest('.d-flex').querySelector('.qty-input');
      const quantite = qtyInput ? parseInt(qtyInput.value) : 1;

      fetch("{% url 'ajouter_au_panier' %}", {
        method: "POST",
        credentials: 'same-origin',
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: new URLSearchParams({ 'produit_id': produitId, 'quantite': quantite })
      })
      .then(resp => resp.json())
      .then(data => {
        if(data.success){
          const cartDesktop = document.getElementById('cart-badge');
          const cartMobile = document.getElementById('cart-badge-mobile');
          if(cartDesktop) cartDesktop.textContent = data.total_items;
          if(cartMobile) cartMobile.textContent = data.total_items;
        } else if(data.redirect){
          window.location.href = data.login_url;
        }
      }).catch(err => console.error(err));
    });
  });

  // ================= MODAL VOIR PLUS SERVICE =================
  document.querySelectorAll('.voir-plus-service').forEach(link => {
    link.addEventListener('click', function(e){
      e.preventDefault();
      const serviceId = this.dataset.serviceId;
      const url = "{% url 'voir_plus_service' service_id=0 %}".replace('0', serviceId);
      fetch(url)
        .then(resp => resp.json())
        .then(data => {
          document.querySelector('#serviceModal .modal-content-container').innerHTML = data.html;
          serviceModal.show();
        }).catch(err => console.error(err));
    });
  });

  // ================= LIKE =================
  document.querySelectorAll('.btn-like').forEach(btn => {
    btn.addEventListener('click', function(){
      const serviceId = this.dataset.serviceId;
      fetch("{% url 'like_service' %}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken
        },
        body: new URLSearchParams({'service_id': serviceId})
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.likes_count !== undefined) {
          this.querySelector('.like-count').textContent = data.likes_count;
        }
      }).catch(err => console.error(err));
    });
  });

  // ================= COMMENTAIRES =================
  let currentServiceId = null;

  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function renderComment(comment, container){
    const div = document.createElement('div');
    div.classList.add('comment-item');
    div.dataset.commentId = comment.id;

    const username = escapeHtml(comment.username || 'Utilisateur');
    const content = escapeHtml(comment.content || '');
    const avatar = comment.avatar_url || '{% static "images/default.png" %}';

    div.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px;">
        <img src="${avatar}" class="comment-avatar">
        <div>
          <strong>${username}</strong> : <span>${content}</span>
          <button class="btn-reply" data-username="${username}" data-comment-id="${comment.id}">Répondre</button>
        </div>
      </div>
    `;
    container.appendChild(div);

    if(comment.replies && comment.replies.length){
      comment.replies.forEach(rep => {
        const replyDiv = document.createElement('div');
        replyDiv.classList.add('reply-container');
        const ruser = escapeHtml(rep.username || 'Utilisateur');
        const rcontent = escapeHtml(rep.content || '');
        const ravatar = rep.avatar_url || '{% static "images/default.png" %}';
        replyDiv.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px;">
            <img src="${ravatar}" class="comment-avatar" style="width:30px;height:30px;">
            <div><strong>${ruser}</strong> : ${rcontent}</div>
          </div>
        `;
        div.appendChild(replyDiv);
      });
    }
  }

  document.querySelectorAll('.btn-comment').forEach(btn => {
    btn.addEventListener('click', function(){
      currentServiceId = this.dataset.serviceId;
      const url = "{% url 'get_comments_service' service_id=0 %}".replace('0', currentServiceId);
      fetch(url)
        .then(resp => resp.json())
        .then(data => {
          const container = document.getElementById('comments-container');
          container.innerHTML = '';
          if(!data.comments || data.comments.length === 0){
            container.innerHTML = '<p>Aucun commentaire pour le moment.</p>';
          } else {
            data.comments.forEach(comment => renderComment(comment, container));
          }
          const input = document.getElementById('new-comment-input');
          if(input) input.value = '';
        }).catch(err => console.error(err));
    });
  });

  // ================= NOUVEAU COMMENTAIRE =================
  const submitBtn = document.getElementById('submit-comment');
  if(submitBtn){
    submitBtn.addEventListener('click', function(){
      const contentInput = document.getElementById('new-comment-input');
      const content = contentInput ? contentInput.value.trim() : '';
      if(!content) return alert('Le commentaire ne peut pas être vide.');

      fetch("{% url 'comment_service' %}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken
        },
        body: new URLSearchParams({ 'service_id': currentServiceId, 'content': content })
      })
      .then(resp => resp.json())
      .then(data => {
        if(data.success){
          const container = document.getElementById('comments-container');
          renderComment({ id: data.comment_id, username: data.username, content: data.content, replies: [], avatar_url: data.avatar_url }, container);
          if(contentInput) contentInput.value = '';
          const countSpan = document.querySelector(`.btn-comment[data-service-id="${currentServiceId}"] .comment-count`);
          if(countSpan && data.comments_count !== undefined) countSpan.textContent = data.comments_count;
        } else {
          alert(data.error || 'Erreur lors de l\'envoi du commentaire.');
        }
      }).catch(err => console.error(err));
    });
  }

  // ================= RÉPONSES AVEC BOUTON SEND =================
  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('btn-reply')){
      const commentId = e.target.dataset.commentId;
      const username = e.target.dataset.username;

      const prevInputContainer = e.target.parentNode.querySelector('.reply-input-container');
      if(prevInputContainer) prevInputContainer.remove();

      const containerDiv = document.createElement('div');
      containerDiv.className = 'reply-input-container mt-2';

      const replyInput = document.createElement('input');
      replyInput.className = 'form-control reply-input';
      replyInput.placeholder = `Répondre à ${username}...`;

      const sendBtn = document.createElement('button');
      sendBtn.className = 'btn btn-primary';
      sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';

      containerDiv.appendChild(replyInput);
      containerDiv.appendChild(sendBtn);
      e.target.parentNode.appendChild(containerDiv);

      function sendReply(){
        const content = replyInput.value.trim();
        if(!content) return alert('Le message ne peut pas être vide.');

        fetch("{% url 'reply_comment_service' %}", {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
          },
          body: new URLSearchParams({ 'comment_id': commentId, 'content': content })
        })
        .then(resp => resp.json())
        .then(data => {
          if(data.success){
            const newReply = document.createElement('div');
            newReply.classList.add('reply-container');
            const avatar = data.avatar_url || '{% static "images/default.png" %}';
            newReply.innerHTML = `
              <div style="display:flex; align-items:center; gap:8px;">
                <img src="${avatar}" class="comment-avatar" style="width:30px;height:30px;">
                <div><strong>${escapeHtml(data.username)}</strong> : ${escapeHtml(data.content)}</div>
              </div>
            `;
            containerDiv.parentNode.appendChild(newReply);
            containerDiv.remove();

            if(data.comments_count !== undefined && currentServiceId){
              const countSpan = document.querySelector(`.btn-comment[data-service-id="${currentServiceId}"] .comment-count`);
              if(countSpan) countSpan.textContent = data.comments_count;
            }
          } else {
            alert(data.error || 'Erreur lors de l\'envoi de la réponse.');
          }
        }).catch(err => console.error(err));
      }

      sendBtn.addEventListener('click', sendReply);
      replyInput.addEventListener('keypress', function(ev){
        if(ev.key === 'Enter' && window.innerWidth > 576){
          sendReply();
        }
      });
    }
  });
});
</script>


{% endblock %}