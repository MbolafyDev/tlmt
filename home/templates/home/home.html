{% extends "base.html" %}
{% load static %}

{% block title %}Home Page{% endblock %}

{% block content %}

<!-- ================= CAROUSEL PRINCIPAL ================= -->
{% include 'includes/carousel.html' %}

<!-- ================= SERVICES ================= -->
<section class="container my-5">
  <h3 class="mb-3">Nos Services & Travaux Réalisés</h3>
  <div class="row g-4">
    {% for service in services %}
    <div class="col-sm-6 col-md-4 col-lg-3">
      <div class="card shadow-sm position-relative service-card" style="height: 500px; overflow: hidden;">

        <!-- Badge statut -->
        {% with statut_display=service.get_statut_display %}
        {% if statut_display %}
          {% if statut_display == 'Planifié' %}
            <span class="badge bg-warning position-absolute top-0 end-0 m-2" style="z-index: 10;">{{ statut_display }}</span>
          {% elif statut_display == 'En cours' %}
            <span class="badge bg-secondary position-absolute top-0 end-0 m-2" style="z-index: 10;">{{ statut_display }}</span>
          {% elif statut_display == 'Terminé' %}
            <span class="badge bg-success position-absolute top-0 end-0 m-2" style="z-index: 10;">{{ statut_display }}</span>
          {% endif %}
        {% endif %}
        {% endwith %}

        <!-- Image service -->
        <div class="service-img-wrapper" style="height: 200px; overflow: hidden;">
          {% if service.images.exists %}
            <img src="{{ service.images.first.image.url }}" class="w-100 h-100" style="object-fit: contain;" alt="{{ service.titre }}">
          {% else %}
            <img src="{% static 'images/default.png' %}" class="w-100 h-100" style="object-fit: contain;" alt="{{ service.titre }}">
          {% endif %}
        </div>

        <!-- Contenu card -->
        <div class="card-body d-flex flex-column" style="height: calc(100% - 200px);">
          <h5 class="card-title text-info">{{ service.titre }}</h5>

          <!-- Aperçu description en haut -->
          <p class="card-text flex-grow-1">
            {% if service.description %}
              {% if service.description|length > 50 %}
                {{ service.description|slice:":50" }}...
              {% else %}
                {{ service.description }}
              {% endif %}
              <a href="#" class="text-primary voir-plus-service" data-service-id="{{ service.id }}" style="text-decoration: underline;">Voir plus</a>
            {% else %}
              Aucune description disponible.
            {% endif %}
          </p>

          <!-- Infos supplémentaires -->
          <p class="mb-1"><strong>Lieu :</strong> {{ service.lieu }}</p>
          <p class="mb-1"><strong>Durée :</strong> {{ service.duree }}</p>
          {% if service.date_debut %}<p class="mb-1"><strong>Début :</strong> {{ service.date_debut }}</p>{% endif %}
          {% if service.date_fin %}<p class="mb-1"><strong>Fin :</strong> {{ service.date_fin }}</p>{% endif %}

          {% if user.is_authenticated %}
          <!-- ICÔNES COMMENTAIRE & LIKE -->
          <div class="d-flex justify-content-start align-items-center mt-2">
            <button class="btn btn-sm btn-outline-primary me-2 like-btn" data-service-id="{{ service.id }}">
              <i class="fas fa-thumbs-up"></i> <span class="like-count">{{ service.likes_count }}</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary comment-btn" data-service-id="{{ service.id }}" data-bs-toggle="modal" data-bs-target="#commentModal">
              <i class="fas fa-comment"></i> <span class="comment-count">{{ service.comments_count }}</span>
            </button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<!-- ================= PRODUITS ================= -->
<section class="container my-5">
  <h3 class="mb-3">Produits en Vente</h3>
  <div class="row g-3">
    {% for produit in produits %}
    <div class="col-6 col-md-3">
      <div class="card text-center shadow-sm p-2">
        {% if produit.images.exists %}
        <div id="carouselProduit{{ produit.id }}" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner">
            {% for image in produit.images.all %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <img src="{{ image.image.url }}" class="d-block mx-auto" style="width:50px; height:50px; object-fit:cover;">
            </div>
            {% endfor %}
          </div>
          {% if produit.images.count > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselProduit{{ produit.id }}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselProduit{{ produit.id }}" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
          {% endif %}
        </div>
        {% else %}
        <img src="{% static 'images/default.png' %}" class="mx-auto" style="width:50px; height:50px; object-fit:cover;">
        {% endif %}
        <p class="mt-2 mb-1 fw-bold">{{ produit.nom }}</p>
        <p class="mb-1 text-danger fw-bold">{{ produit.prix }} Ar</p>
        <div class="d-flex justify-content-center align-items-center">
          <input type="number" value="1" min="1" class="form-control form-control-sm me-1 qty-input" style="width:50px;">
          <button class="btn btn-success btn-sm btn-add-cart" data-id="{{ produit.id }}">
            <i class="fas fa-cart-arrow-down"></i>
          </button>
          <a href="{% url 'produit_detail_home' produit_id=produit.id %}" class="btn btn-info btn-sm ms-1">
            <i class="fas fa-eye"></i>
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% include 'includes/paginator.html' %}
</section>

<!-- Modal container pour service -->
<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content-container"></div>
  </div>
</div>

<!-- Modal pour les commentaires -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Commentaires</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div id="comments-container">
          <!-- Les commentaires seront chargés ici via AJAX -->
        </div>
        {% if user.is_authenticated %}
        <div class="mt-3">
          <input type="text" class="form-control" id="new-comment-input" placeholder="Écrire un commentaire...">
          <button class="btn btn-primary mt-2" id="submit-comment">Envoyer</button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // Ajouter au panier
    document.querySelectorAll('.btn-add-cart').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const produitId = this.dataset.id;
            const qtyInput = this.closest('.d-flex').querySelector('.qty-input');
            const quantite = qtyInput ? parseInt(qtyInput.value) : 1;

            fetch("{% url 'ajouter_au_panier' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: new URLSearchParams({
                    'produit_id': produitId,
                    'quantite': quantite
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    const cartBadgeDesktop = document.getElementById('cart-badge');
                    const cartBadgeMobile = document.getElementById('cart-badge-mobile');
                    if(cartBadgeDesktop) cartBadgeDesktop.textContent = data.total_items;
                    if(cartBadgeMobile) cartBadgeMobile.textContent = data.total_items;
                } else if(data.redirect){
                    window.location.href = data.login_url;
                }
            })
            .catch(error => console.error('Erreur AJAX panier:', error));
        });
    });

    // Voir plus service - modal AJAX
    const serviceModal = new bootstrap.Modal(document.getElementById('serviceModal'));
    document.querySelectorAll('.voir-plus-service').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const serviceId = this.dataset.serviceId;
            fetch(`/service/voir-plus/${serviceId}/`)
                .then(resp => resp.json())
                .then(data => {
                    document.querySelector('#serviceModal .modal-content-container').innerHTML = data.html;
                    serviceModal.show();
                })
                .catch(err => console.error("Erreur modal service:", err));
        });
    });

    // Like & Dislike
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const serviceId = this.dataset.serviceId;
            fetch("{% url 'like_service' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: new URLSearchParams({service_id: serviceId})
            })
            .then(resp => resp.json())
            .then(data => {
                this.querySelector('.like-count').textContent = data.likes_count;
            });
        });
    });

    // Commentaires modal
    let currentServiceId = null;

    document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentServiceId = this.dataset.serviceId;
            fetch(`/service/comments/${currentServiceId}/`)
                .then(resp => resp.json())
                .then(data => {
                    const container = document.getElementById('comments-container');
                    container.innerHTML = '';
                    if(data.comments.length > 0){
                        data.comments.forEach(comment => {
                            const div = document.createElement('div');
                            div.classList.add('mb-2');
                            div.innerHTML = `<strong>${comment.username}</strong> : ${comment.content}`;
                            container.appendChild(div);
                        });
                    } else {
                        container.innerHTML = '<p>Aucun commentaire pour le moment.</p>';
                    }
                    document.getElementById('new-comment-input').value = '';
                });
        });
    });

    const submitBtn = document.getElementById('submit-comment');
    if(submitBtn){
        submitBtn.addEventListener('click', function(){
            const content = document.getElementById('new-comment-input').value.trim();
            if(!content) return alert('Le commentaire ne peut pas être vide.');
            fetch("{% url 'comment_service' %}", {
                method: 'POST',
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: new URLSearchParams({
                    'service_id': currentServiceId,
                    'content': content
                })
            })
            .then(resp => resp.json())
            .then(data => {
                if(data.success){
                    const container = document.getElementById('comments-container');
                    const div = document.createElement('div');
                    div.classList.add('mb-2');
                    div.innerHTML = `<strong>${data.username}</strong> : ${data.content}`;
                    container.appendChild(div);
                    document.getElementById('new-comment-input').value = '';

                    // mettre à jour le compteur dans la card
                    const commentCountSpan = document.querySelector(`.comment-btn[data-service-id="${currentServiceId}"] .comment-count`);
                    if(commentCountSpan) commentCountSpan.textContent = data.comments_count;
                } else {
                    alert(data.error);
                }
            });
        });
    }

});
</script>

{% endblock %}
