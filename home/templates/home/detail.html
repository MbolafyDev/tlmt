{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ produit.nom }} - Zara Store{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row g-4">

    <!-- Images -->
    <div class="col-md-6">
      <div class="border p-3 rounded shadow-sm">
        {% with images=produit.images.all %}
          {% if images|length %}
            <div id="carouselDetail{{ produit.pk }}" class="carousel slide" data-bs-ride="carousel">
              <div class="carousel-inner">
                {% for image in images %}
                  <div class="carousel-item {% if forloop.first %}active{% endif %}">
                    <img src="{{ image.image.url }}" class="d-block w-100" alt="{{ produit.nom }}">
                  </div>
                {% endfor %}
              </div>
              {% if images|length > 1 %}
                <button class="carousel-control-prev" type="button"
                        data-bs-target="#carouselDetail{{ produit.pk }}" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Précédent</span>
                </button>
                <button class="carousel-control-next" type="button"
                        data-bs-target="#carouselDetail{{ produit.pk }}" data-bs-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Suivant</span>
                </button>
              {% endif %}
            </div>
          {% else %}
            <img src="{% static 'images/default.png' %}" class="img-fluid" alt="{{ produit.nom }}">
          {% endif %}
        {% endwith %}
      </div>
    </div>

    <!-- Détails -->
    <div class="col-md-6">
      <h2 class="fw-bold">{{ produit.nom }}</h2>
      <p class="text-muted">{{ produit.description_courte }}</p>

      <h3 class="mt-2">
        {% if produit.prix_original %}
          <span class="text-decoration-line-through text-muted fs-5">{{ produit.prix_original|intcomma }} Ar</span>
        {% endif %}
        <span class="fw-bold text-danger ms-3">{{ produit.prix|intcomma }} Ar</span>
      </h3>

      {% with caracteristiques=produit.caracteristiques.all %}
        {% if caracteristiques|length %}
          <ul class="mt-3">
            {% for c in caracteristiques %}
              <li>{{ c.nom }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      {% with couleurs=produit.couleurs.all %}
        {% if couleurs|length %}
          <div class="mt-3">
            <label for="color" class="form-label">Couleur :</label>
            <select id="color" class="form-select w-50">
              {% for couleur in couleurs %}
                <option>{{ couleur.nom }}</option>
              {% endfor %}
            </select>
          </div>
        {% endif %}
      {% endwith %}

      <!-- Boutons et quantité -->
      <div class="d-flex align-items-center mt-4 flex-wrap">
        <div class="input-group input-group-sm" style="width: 120px;">
          <button class="btn btn-outline-secondary btn-decrease" type="button">-</button>
          <input type="number" min="1" step="1" class="form-control text-center qty-input" value="1">
          <button class="btn btn-outline-secondary btn-increase" type="button">+</button>
        </div>
        <button class="btn btn-success btn-lg ms-3 mt-2 mt-md-0 btn-add-cart" data-id="{{ produit.id }}">
          <i class="fas fa-cart-arrow-down"></i> Ajouter au panier
        </button>
      </div>

      <div class="mt-3">
        <a href="{% url 'home' %}" class="btn btn-link">
          <i class="fas fa-arrow-left"></i> Retour à la boutique
        </a>
      </div>
    </div>
  </div>

  <div class="mt-5">
    <h4>Description détaillée</h4>
    <p>{{ produit.description_detaillee|default:"Pas de description détaillée disponible." }}</p>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
(function() {
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const input = document.querySelector('.qty-input');
  document.querySelector('.btn-increase').addEventListener('click', () => {
    input.value = Math.max(1, parseInt(input.value || '1', 10) + 1);
  });
  document.querySelector('.btn-decrease').addEventListener('click', () => {
    input.value = Math.max(1, parseInt(input.value || '1', 10) - 1);
  });

  document.querySelector('.btn-add-cart').addEventListener('click', function() {
    const produit_id = this.dataset.id;
    const quantite = Math.max(1, parseInt(input.value || '1', 10));
    const csrftoken = getCookie('csrftoken');

    fetch("{% url 'ajouter_au_panier' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: `produit_id=${encodeURIComponent(produit_id)}&quantite=${encodeURIComponent(quantite)}`
    })
    .then(res => res.ok ? res.json() : Promise.reject(res))
    .then(data => {
      if (data.success) {
        const badge = document.querySelector('#cart-badge');
        if (badge) badge.textContent = data.total_items;
      }
    })
    .catch(err => console.error('Erreur réseau', err));
  });
})();
</script>
{% endblock extra_js %}
