{% load static %}

<style>
/* ---------- Desktop navbar ---------- */
.navbar-nav .nav-item { margin-right: 8px; }
.navbar-nav .nav-link { padding: 5px 8px; font-size: 1.4rem; position: relative; }
.navbar-brand { padding: 0; }

/* Barre de recherche (même composant desktop & mobile-top) */
.navbar-search{
  display:flex; align-items:center; gap:.5rem; min-width:0;
}
.navbar-search .form-control{ height:36px; min-width:0; flex:1 1 auto; }
.navbar-search .btn{ height:36px; display:flex; align-items:center; }

/* Empêche les sauts de ligne dans la barre supérieure */
.navbar .container-fluid{ flex-wrap: nowrap; }

/* Ajustements MOBILE pour garder le bouton menu sur la même ligne */
@media (max-width: 991px){
  .navbar .container-fluid{ gap:6px; }
  .navbar-brand{ flex:0 0 auto; }
  /* Forme mobile : largeur bornée pour ne pas pousser le bouton menu */
  form.navbar-search.d-lg-none{
    flex:0 1 auto;
    width:clamp(140px, 58vw, 320px);   /* ← ajuste ici si tu veux plus court/long */
  }
  #mobileMenuBtn{
    flex:0 0 auto;
    white-space:nowrap;
  }
}

/* Menus dropdown au-dessus de tout */
.dropdown-menu{ z-index:2000; }

/* Dropdown Paramètres plus petit */
.dropdown-menu-sm{ font-size:.9rem; }
.dropdown-menu-sm .dropdown-item{ padding:.35rem .75rem; }

/* ---------- Mobile sidebar ---------- */
:root { --sidebar-w: 280px; }

#mobileSidebar{
  position:fixed; top:0; left:-100vw; height:100%; width:min(90vw, var(--sidebar-w));
  background:#fff; box-shadow:2px 0 5px rgba(0,0,0,.3); z-index:1050;
  transition:left .3s ease; padding-top:60px; box-sizing:border-box;
}
#mobileSidebar *{ box-sizing:border-box; max-width:100%; }
#mobileSidebar .close-btn{
  position:absolute; top:10px; right:12px; font-size:1.5rem; cursor:pointer;
}

/* Liste principale */
#mobileSidebar ul.mobile-menu{ margin:0; padding:0; list-style:none; }
#mobileSidebar ul.mobile-menu > li{ padding:10px 14px; }
#mobileSidebar ul.mobile-menu > li > a.menu-link{
  display:flex; align-items:center; justify-content:space-between;
  gap:.75rem; text-decoration:none; color:#333; font-size:1rem;
  white-space:normal; overflow:hidden; text-overflow:ellipsis; word-break:break-word;
}
#mobileSidebar ul.mobile-menu > li > a.menu-link .left{
  display:flex; align-items:center; gap:.6rem; min-width:0;
}
#mobileSidebar ul.mobile-menu > li > a.menu-link .label{
  min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:normal;
}

/* Sous-menus */
#mobileSidebar .submenu{ list-style:none; padding:0; margin:8px 0 0 0; display:none; }
#mobileSidebar .submenu li{ padding:8px 14px 8px 34px; }
#mobileSidebar .submenu li a{
  display:flex; align-items:center; gap:.6rem;
  text-decoration:none; color:#333; font-size:.95rem; line-height:1.25;
  white-space:normal; overflow-wrap:anywhere;
}

/* Overlay */
#sidebarOverlay{
  position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1040; display:none;
}

/* Active */
#mobileSidebar.active{ left:0; }
#sidebarOverlay.active{ display:block; }
</style>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid align-items-center">

    <!-- Logo -->
    <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
      <img src="{% static 'images/logo.jpg' %}" alt="Logo TLMT" width="40">
    </a>

    <!-- Barre de recherche : MOBILE (à côté du logo) -->
    <form class="navbar-search ms-2 flex-grow-1 d-flex d-lg-none" method="get" action="{% url 'produit_list' %}">
      {# Remplace 'produit_list' par ta vue de recherche si besoin #}
      <input class="form-control" type="search" name="q" placeholder="Rechercher…" aria-label="Rechercher">
      <button class="btn btn-outline-secondary" type="submit" title="Rechercher">
        <i class="fas fa-search"></i>
      </button>
    </form>

    <!-- Bouton sidebar mobile -->
    <button class="btn d-lg-none ms-1" id="mobileMenuBtn" aria-label="Ouvrir le menu">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Barre de recherche : DESKTOP (à côté du logo) -->
    <form class="navbar-search ms-2 d-none d-lg-flex" method="get" action="{% url 'produit_list' %}">
      <input class="form-control" type="search" name="q" placeholder="Rechercher…" aria-label="Rechercher">
      <button class="btn btn-outline-secondary" type="submit" title="Rechercher">
        <i class="fas fa-search"></i>
      </button>
    </form>

    <!-- Zone icônes + menus (desktop) -->
    <div class="collapse navbar-collapse" id="navbarIcons">
      <ul class="navbar-nav ms-auto align-items-center">

        <!-- Panier -->
        <li class="nav-item">
          <a class="nav-link position-relative" href="{% url 'checkout' %}" data-bs-toggle="tooltip" title="Panier">
            <i class="fas fa-shopping-cart"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ total_items }}</span>
          </a>
        </li>

        <!-- Services -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="servicesDropdown" role="button"
             data-bs-toggle="dropdown" aria-expanded="false" title="Services">
            <i class="fas fa-puzzle-piece"></i>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="servicesDropdown">
            <li><a class="dropdown-item" href="#"><i class="fas fa-tools"></i> Installation</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-hand-holding-usd"></i> Ventes</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-file-invoice"></i> Devis</a></li>
            <li><a class="dropdown-item" href="{% url 'demande_dimensionnement' %}"><i class="fas fa-bolt"></i> Dimensionnement Panneau Solaire</a></li>
          </ul>
        </li>

        <!-- Contact -->
        <li class="nav-item">
          <a class="nav-link" href="{% url 'contact' %}" data-bs-toggle="tooltip" title="Contacter-nous">
            <i class="fas fa-envelope"></i>
          </a>
        </li>

        <!-- À propos -->
        <li class="nav-item">
          <a class="nav-link" href="{% url 'apropos' %}" data-bs-toggle="tooltip" title="À propos">
            <i class="fas fa-info-circle"></i>
          </a>
        </li>

        {# ========= PARAMÈTRES AVANT UTILISATEUR (DESKTOP) ========= #}
        {% if user.is_authenticated %}
          {% if user.is_superuser or user.role == "admin" %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="settingsDropdown" role="button"
                 data-bs-toggle="dropdown" aria-expanded="false" title="Paramètres">
                <i class="fas fa-cog"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end dropdown-menu-sm" aria-labelledby="settingsDropdown">
                <li class="dropdown-header">Paramètres</li>
                <li><a class="dropdown-item" href="{% url 'user_list' %}"><i class="fas fa-users-cog"></i> Listes des utilisateurs</a></li>
                <li><a class="dropdown-item" href="{% url 'produit_list' %}"><i class="fas fa-box"></i> Listes des Produits</a></li>
              </ul>
            </li>
          {% endif %}
        {% endif %}

        <!-- Utilisateur -->
        {% if user.is_authenticated %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
               data-bs-toggle="dropdown" aria-expanded="false" title="Utilisateur">
              <i class="fas fa-user"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
              <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="fas fa-tools"></i> Paramètres du compte</a></li>
            </ul>
          </li>
        {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'login' %}" title="Connexion"><i class="fas fa-sign-in-alt"></i></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'register' %}" title="Inscription"><i class="fas fa-user-plus"></i></a>
          </li>
        {% endif %}

      </ul>
    </div>
  </div>
</nav>

<!-- Sidebar mobile -->
<div id="mobileSidebar">
  <span class="close-btn" id="closeSidebarBtn" aria-label="Fermer">&times;</span>

  <ul class="mobile-menu">

    <!-- Panier -->
    <li>
      <a href="{% url 'checkout' %}" class="menu-link">
        <span class="left"><i class="fas fa-shopping-cart"></i> <span class="label">Panier</span></span>
        <span class="badge bg-danger">{{ total_items }}</span>
      </a>
    </li>

    <!-- Services (mobile) -->
    <li>
      <a href="#" class="menu-link submenu-toggle">
        <span class="left"><i class="fas fa-puzzle-piece"></i> <span class="label">Services</span></span>
        <i class="fas fa-caret-down"></i>
      </a>
      <ul class="submenu">
        <li><a href="#"><i class="fas fa-tools"></i> Installation</a></li>
        <li><a href="#"><i class="fas fa-hand-holding-usd"></i> Ventes</a></li>
        <li><a href="#"><i class="fas fa-file-invoice"></i> Devis</a></li>
        <li><a href="{% url 'demande_dimensionnement' %}"><i class="fas fa-bolt"></i> Dimensionnement</a></li>
      </ul>
    </li>

    <!-- Paramètres AVANT Utilisateur (mobile) -->
    {% if user.is_authenticated %}
      {% if user.is_superuser or user.role == "admin" %}
        <li>
          <a href="#" class="menu-link submenu-toggle">
            <span class="left"><i class="fas fa-cog"></i> <span class="label">Paramètres</span></span>
            <i class="fas fa-caret-down"></i>
          </a>
          <ul class="submenu">
            <li><a href="{% url 'user_list' %}"><i class="fas fa-users-cog"></i> Listes des utilisateurs</a></li>
            <li><a href="{% url 'produit_list' %}"><i class="fas fa-box"></i> Listes des Produits</a></li>
          </ul>
        </li>
      {% endif %}
    {% endif %}

    {% if user.is_authenticated %}
      <li>
        <a href="{% url 'logout' %}" class="menu-link">
          <span class="left"><i class="fas fa-sign-out-alt"></i> <span class="label">Déconnexion</span></span>
        </a>
      </li>
      <li>
        <a href="{% url 'profile' %}" class="menu-link">
          <span class="left"><i class="fas fa-tools"></i> <span class="label">Paramètres du compte</span></span>
        </a>
      </li>
    {% else %}
      <li><a href="{% url 'login' %}" class="menu-link"><span class="left"><i class="fas fa-sign-in-alt"></i> <span class="label">Connexion</span></span></a></li>
      <li><a href="{% url 'register' %}" class="menu-link"><span class="left"><i class="fas fa-user-plus"></i> <span class="label">Inscription</span></span></a></li>
    {% endif %}
  </ul>
</div>

<div id="sidebarOverlay"></div>

<script>
(function(){
  function onReady(fn){
    if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn,{once:true});}else{fn();}
  }

  onReady(function(){
    if(window.bootstrap){
      // Tooltips & Dropdowns (desktop)
      document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el){ bootstrap.Tooltip.getOrCreateInstance(el); });
      document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(function(el){ bootstrap.Dropdown.getOrCreateInstance(el); });
    }

    // Sidebar mobile
    const mobileBtn=document.getElementById('mobileMenuBtn');
    const mobileSidebar=document.getElementById('mobileSidebar');
    const overlay=document.getElementById('sidebarOverlay');
    const closeBtn=document.getElementById('closeSidebarBtn');
    if(mobileBtn && mobileSidebar && overlay && closeBtn){
      mobileBtn.addEventListener('click',()=>{ mobileSidebar.classList.add('active'); overlay.classList.add('active'); });
      overlay.addEventListener('click',()=>{ mobileSidebar.classList.remove('active'); overlay.classList.remove('active'); });
      closeBtn.addEventListener('click',()=>{ mobileSidebar.classList.remove('active'); overlay.classList.remove('active'); });
    }

    // Sous-menus mobile
    document.querySelectorAll('.submenu-toggle').forEach(function(t){
      t.addEventListener('click',function(e){
        e.preventDefault();
        const s=this.parentElement.querySelector('.submenu');
        if(s){ s.style.display = (s.style.display==='block') ? 'none' : 'block'; }
      });
    });
  });
})();
</script>
