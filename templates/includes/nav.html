{% load static %}
<style>
/* ================= Navbar Modernisée ================= */
.navbar { box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: #fff; }
.navbar-nav .nav-link { transition: 0.2s; }
.navbar-nav .nav-link:hover { color: #ffcc00; transform: scale(1.05); }

/* Barre de recherche améliorée */
.navbar-search .form-control {
    border-radius: 50px;
    border: 1px solid #ddd;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    padding: 6px 12px;
}
.navbar-search .btn {
    border-radius: 50px;
    margin-left: 4px;
}
#cart-badge, #cart-badge-mobile {
    font-size:0.75rem;
    padding:0.25em 0.5em;
    background:linear-gradient(45deg, #f9fd0d, #ffcc00);
    color:#000;
    box-shadow:0 2px 5px rgba(0,0,0,0.2);
}

/* Sidebar mobile */
#mobileSidebar {
    position: fixed;
    top: 0;
    left: -250px;
    width: 250px;
    height: 100%;
    background: #fff;
    box-shadow: 2px 0 12px rgba(0,0,0,0.2);
    z-index: 1050;
    overflow-y: auto;
    transition: left 0.3s ease;
}
#mobileSidebar ul { list-style: none; padding: 0; margin: 0; }
#mobileSidebar li { border-bottom: 1px solid #eee; }
#mobileSidebar li a { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; color: #333; text-decoration: none; transition: 0.2s; }
#mobileSidebar li a:hover { background: #f9fd0d; color: #000; }
#mobileSidebar .submenu { display: none; flex-direction: column; }
#mobileSidebar .submenu li a { padding-left: 32px; }
#sidebarOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:1040; }
.close-btn { font-size: 2rem; padding: 0 12px; cursor: pointer; display:block; text-align:right; }

/* Mobile: barre de recherche, panier et bouton toggle en ligne */
.mobile-topbar {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-grow: 1;
    flex-wrap: nowrap; /* empêche la recherche de passer en dessous */
}
.mobile-topbar .navbar-search {
    display: flex;
    flex-grow: 1;
    min-width: 0;
}
.mobile-topbar .navbar-search .form-control {
    flex-grow: 1;
    min-width: 0;
}

@media(min-width:992px){
    #mobileSidebar, #sidebarOverlay { display: none; }
}
</style>

<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container-fluid align-items-center">
        <!-- Logo -->
        <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
            <img src="{% static 'images/logo.jpg' %}" alt="Logo TLMT" width="40" style="border-radius:50%;">
        </a>

        <!-- Mobile topbar: recherche + panier + toggle -->
        <div class="d-flex d-lg-none mobile-topbar ms-2">
            <form class="navbar-search flex-grow-1" method="get" action="{% url 'search_global' %}">
                <input class="form-control" type="search" name="q" placeholder="Rechercher…" aria-label="Rechercher">
                <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i></button>
            </form>
            {% if user.is_authenticated %}
            <a class="nav-link position-relative" href="{% url 'checkout' %}" title="Panier">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-badge-mobile" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ total_items }}</span>
            </a>
            {% endif %}
            <button class="btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        </div>

        <!-- Search desktop -->
        <form class="navbar-search ms-2 d-none d-lg-flex" method="get" action="{% url 'search_global' %}">
            <input class="form-control" type="search" name="q" placeholder="Rechercher…" aria-label="Rechercher">
            <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i></button>
        </form>

        <!-- Desktop menu -->
        <div class="collapse navbar-collapse justify-content-end d-none d-lg-flex" id="navbarIcons">
            <ul class="navbar-nav align-items-center">
                {% if user.is_authenticated %}
                <li class="nav-item">
                    <a class="nav-link position-relative" href="{% url 'checkout' %}" title="Panier">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cart-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ total_items }}</span>
                    </a>
                </li>
                {% endif %}

                <!-- Services -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" title="Services">
                        <i class="fas fa-puzzle-piece"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-tools"></i> Installation</a></li>
                        <li><a class="dropdown-item" href="{% url 'ventes' %}"><i class="fas fa-hand-holding-usd"></i> Ventes</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-file-invoice"></i> Devis</a></li>
                        <li><a class="dropdown-item" href="{% url 'demande_dimensionnement' %}"><i class="fas fa-bolt"></i> Dimensionnement Panneau Solaire</a></li>
                        <li><a class="dropdown-item" href="{% url 'calcul_tuyauterie' %}"><i class="fas fa-tint"></i> Calcul Tuyauterie</a></li>
                    </ul>
                </li>

                <!-- Contact -->
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'contact' %}" title="Contact"><i class="fas fa-envelope"></i></a>
                </li>

                <!-- À propos -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" title="À propos">
                        <i class="fas fa-info-circle"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'apropos' %}"><i class="fas fa-info-circle"></i> À propos TLMT Services</a></li>
                        <li><a class="dropdown-item" href="{% url 'apropos_dev' %}"><i class="fas fa-laptop-code"></i> À propos du développeur</a></li>
                    </ul>
                </li>

                <!-- User et admin menus -->
                {% if user.is_authenticated %}
                    {% if user.is_superuser or user.role == "admin" %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" title="Paramètres">
                            <i class="fas fa-cog"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{% url 'user_list' %}"><i class="fas fa-users-cog"></i> Utilisateurs</a></li>
                            <li><a class="dropdown-item" href="{% url 'produit_list' %}"><i class="fas fa-box"></i> Produits</a></li>
                            <li><a class="dropdown-item" href="{% url 'categorie_list' %}"><i class="fas fa-tags"></i> Catégories</a></li>
                            <li><a class="dropdown-item" href="{% url 'caracteristique_list' %}"><i class="fas fa-list"></i> Caractéristiques</a></li>
                            <li><a class="dropdown-item" href="{% url 'appareil_list' %}"><i class="fas fa-shower"></i> Appareils sanitaires</a></li>
                            <li><a class="dropdown-item" href="{% url 'service_list' %}"><i class="fas fa-concierge-bell"></i> Services</a></li>
                        </ul>
                    </li>
                    {% endif %}

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" title="Utilisateur">
                            <i class="fas fa-user"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="fas fa-tools"></i> Paramètres du compte</a></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
                        </ul>
                    </li>
                {% else %}
                    <li class="nav-item"><a class="nav-link" href="{% url 'login' %}"><i class="fas fa-sign-in-alt"></i></a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'register' %}"><i class="fas fa-user-plus"></i></a></li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

<!-- Sidebar Mobile -->
<div id="mobileSidebar">
    <span class="close-btn" id="closeSidebarBtn">&times;</span>
    <ul>
        <!-- Services -->
        <li>
            <a href="#" class="submenu-toggle"><span><i class="fas fa-puzzle-piece"></i> Services</span> <i class="fas fa-caret-down"></i></a>
            <ul class="submenu">
                <li><a href="#"><i class="fas fa-tools"></i> Installation</a></li>
                <li><a href="{% url 'ventes' %}"><i class="fas fa-hand-holding-usd"></i> Ventes</a></li>
                <li><a href="#"><i class="fas fa-file-invoice"></i> Devis</a></li>
                <li><a href="{% url 'demande_dimensionnement' %}"><i class="fas fa-bolt"></i> Dimensionnement</a></li>
                <li><a href="{% url 'calcul_tuyauterie' %}"><i class="fas fa-tint"></i> Calcul Tuyauterie</a></li>
            </ul>
        </li>

        {% if user.is_authenticated %}
            {% if user.is_superuser or user.role == "admin" %}
            <li>
                <a href="#" class="submenu-toggle"><span><i class="fas fa-cog"></i> Paramètres</span> <i class="fas fa-caret-down"></i></a>
                <ul class="submenu">
                    <li><a href="{% url 'user_list' %}">Utilisateurs</a></li>
                    <li><a href="{% url 'produit_list' %}">Produits</a></li>
                    <li><a href="{% url 'categorie_list' %}">Catégories</a></li>
                    <li><a href="{% url 'caracteristique_list' %}">Caractéristiques</a></li>
                    <li><a href="{% url 'appareil_list' %}">Appareils sanitaires</a></li>
                    <li><a href="{% url 'service_list' %}">Services</a></li>
                </ul>
            </li>
            {% endif %}
        {% endif %}

        <li><a href="{% url 'contact' %}"><i class="fas fa-envelope"></i> Contact</a></li>

        <li>
            <a href="#" class="submenu-toggle"><span><i class="fas fa-info-circle"></i> À propos</span> <i class="fas fa-caret-down"></i></a>
            <ul class="submenu">
                <li><a href="{% url 'apropos' %}">À propos TLMT Services</a></li>
                <li><a href="{% url 'apropos_dev' %}">À propos du développeur</a></li>
            </ul>
        </li>

        {% if user.is_authenticated %}
            <li><a href="{% url 'profile' %}">Paramètres du compte</a></li>
            <li><a href="{% url 'logout' %}">Déconnexion</a></li>
        {% else %}
            <li><a href="{% url 'login' %}">Connexion</a></li>
            <li><a href="{% url 'register' %}">Inscription</a></li>
        {% endif %}
    </ul>
</div>
<div id="sidebarOverlay"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mobileBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('mobileSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const closeBtn = document.getElementById('closeSidebarBtn');

    mobileBtn?.addEventListener('click', () => { sidebar.style.left='0'; overlay.style.display='block'; });
    closeBtn?.addEventListener('click', () => { sidebar.style.left='-250px'; overlay.style.display='none'; });
    overlay?.addEventListener('click', () => { sidebar.style.left='-250px'; overlay.style.display='none'; });

    // Toggle sous-menu
    document.querySelectorAll('#mobileSidebar .submenu-toggle').forEach(btn=>{
        btn.addEventListener('click', e=>{
            e.preventDefault();
            const submenu = btn.nextElementSibling;
            submenu.style.display = (submenu.style.display === 'block') ? 'none' : 'block';
        });
    });
});
</script>
