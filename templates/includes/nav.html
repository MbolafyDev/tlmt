{% load static %}

<style>
/* ---------- Desktop navbar ---------- */
.navbar-nav .nav-item { margin-right: 8px; }
.navbar-nav .nav-link { padding: 5px 8px; font-size: 1.4rem; position: relative; }
.navbar-brand { padding: 0; }

/* Champ recherche dropdown (desktop) */
#searchDropdown{
  display:none; position:absolute; top:100%; right:0; width:125px;
  padding:2px 5px; border:1px solid #ccc; border-radius:4px; background:#fff; z-index:1000;
}
#searchDropdown input{ width:100%; border:none; outline:none; padding:2px 4px; }

/* Menus dropdown au-dessus du search */
.dropdown-menu{ z-index:2000; }

/* Dropdown Paramètres + petit */
.dropdown-menu-sm{ font-size:.9rem; }
.dropdown-menu-sm .dropdown-item{ padding:.35rem .75rem; }

/* ---------- Mobile sidebar ---------- */
:root { --sidebar-w: 280px; }

#mobileSidebar{
  position:fixed; top:0; left:-100vw; height:100%; width:min(90vw, var(--sidebar-w));
  background:#fff; box-shadow:2px 0 5px rgba(0,0,0,.3); z-index:1050;
  transition:left .3s ease; padding-top:60px; box-sizing:border-box;
}
#mobileSidebar *{ box-sizing:border-box; max-width:100%; }
#mobileSidebar .close-btn{
  position:absolute; top:10px; right:12px; font-size:1.5rem; cursor:pointer;
}

/* Liste principale */
#mobileSidebar ul.mobile-menu{ margin:0; padding:0; list-style:none; }
#mobileSidebar ul.mobile-menu > li{ padding:10px 14px; }
#mobileSidebar ul.mobile-menu > li > a{
  display:flex; align-items:center; justify-content:space-between;
  gap:.75rem; text-decoration:none; color:#333; font-size:1rem;
  white-space:normal; overflow:hidden; text-overflow:ellipsis; word-break:break-word;
}
#mobileSidebar ul.mobile-menu > li > a .left{
  display:flex; align-items:center; gap:.6rem; min-width:0;
}
#mobileSidebar ul.mobile-menu > li > a .label{
  min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:normal;
}

/* Sous-menus */
#mobileSidebar .submenu{ list-style:none; padding:0; margin:8px 0 0 0; display:none; }
#mobileSidebar .submenu li{ padding:8px 14px 8px 34px; }
#mobileSidebar .submenu li a{
  display:flex; align-items:center; gap:.6rem;
  text-decoration:none; color:#333; font-size:.95rem; line-height:1.25;
  white-space:normal; overflow-wrap:anywhere;
}

/* Overlay */
#sidebarOverlay{
  position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1040; display:none;
}

/* Active */
#mobileSidebar.active{ left:0; }
#sidebarOverlay.active{ display:block; }

/* Responsive */
@media(max-width: 991px){
  #navbarIcons{ display:none !important; }
  #searchDropdown{ width:100%; left:0; right:0; top:auto; margin-top:5px; }
}
</style>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">

    <!-- Logo -->
    <a class="navbar-brand" href="{% url 'home' %}">
      <img src="{% static 'images/logo.jpg' %}" alt="Logo TLMT" width="40">
    </a>

    <!-- Toggle mobile sidebar -->
    <button class="btn d-lg-none" id="mobileMenuBtn">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Navbar icons (desktop) -->
    <div class="collapse navbar-collapse justify-content-end" id="navbarIcons">
      <ul class="navbar-nav align-items-center">

        <!-- Recherche -->
        <li class="nav-item position-relative">
          <a class="nav-link" href="#" id="searchIcon" data-bs-toggle="tooltip" title="Recherche">
            <i class="fas fa-search"></i>
          </a>
          <div id="searchDropdown">
            <input type="text" placeholder="Rechercher...">
          </div>
        </li>

        <!-- Panier -->
        <li class="nav-item">
          <a class="nav-link position-relative" href="{% url 'checkout' %}" data-bs-toggle="tooltip" title="Panier">
            <i class="fas fa-shopping-cart"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ total_items }}</span>
          </a>
        </li>

        <!-- Services -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="servicesDropdown" role="button"
             data-bs-toggle="dropdown" aria-expanded="false" title="Services">
            <i class="fas fa-puzzle-piece"></i>
          </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="servicesDropdown">
            <li><a class="dropdown-item" href="#"><i class="fas fa-tools"></i> Installation</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-hand-holding-usd"></i> Ventes</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-file-invoice"></i> Devis</a></li>
            <li><a class="dropdown-item" href="{% url 'demande_dimensionnement' %}"><i class="fas fa-bolt"></i> Dimensionnement Panneau Solaire</a></li>
          </ul>
        </li>

        <!-- Contact -->
        <li class="nav-item">
          <a class="nav-link" href="{% url 'contact' %}" data-bs-toggle="tooltip" title="Contacter-nous">
            <i class="fas fa-envelope"></i>
          </a>
        </li>

        <!-- À propos -->
        <li class="nav-item">
          <a class="nav-link" href="{% url 'apropos' %}" data-bs-toggle="tooltip" title="À propos">
            <i class="fas fa-info-circle"></i>
          </a>
        </li>

        {# ========= PARAMÈTRES AVANT UTILISATEUR (DESKTOP) ========= #}
        {% if user.is_authenticated %}
          {% if user.is_superuser or user.role == "admin" %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="settingsDropdown" role="button"
                 data-bs-toggle="dropdown" aria-expanded="false" title="Paramètres">
                <i class="fas fa-cog"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end dropdown-menu-sm" aria-labelledby="settingsDropdown">
                <li class="dropdown-header">Paramètres</li>
                <li><a class="dropdown-item" href="{% url 'user_list' %}"><i class="fas fa-users-cog"></i> Listes des utilisateurs</a></li>
                <li><a class="dropdown-item" href="{% url 'produit_list' %}"><i class="fas fa-box"></i> Listes des Produits</a></li>
              </ul>
            </li>
          {% endif %}
        {% endif %}

        <!-- Utilisateur -->
        {% if user.is_authenticated %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
               data-bs-toggle="dropdown" aria-expanded="false" title="Utilisateur">
              <i class="fas fa-user"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
              <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="fas fa-tools"></i> Paramètres du compte</a></li>
            </ul>
          </li>
        {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'login' %}" title="Connexion"><i class="fas fa-sign-in-alt"></i></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'register' %}" title="Inscription"><i class="fas fa-user-plus"></i></a>
          </li>
        {% endif %}

      </ul>
    </div>
  </div>
</nav>

<!-- Sidebar mobile -->
<div id="mobileSidebar">
  <span class="close-btn" id="closeSidebarBtn">&times;</span>
  <ul class="mobile-menu list-unstyled">

    <li>
      <a href="#" class="menu-link">
        <span class="left"><i class="fas fa-search"></i> <span class="label">Recherche</span></span>
      </a>
    </li>

    <li>
      <a href="{% url 'checkout' %}" class="menu-link">
        <span class="left"><i class="fas fa-shopping-cart"></i> <span class="label">Panier</span></span>
        <span class="badge bg-danger">{{ total_items }}</span>
      </a>
    </li>

    <!-- Services (mobile) -->
    <li>
      <a href="#" class="menu-link submenu-toggle">
        <span class="left"><i class="fas fa-puzzle-piece"></i> <span class="label">Services</span></span>
        <i class="fas fa-caret-down"></i>
      </a>
      <ul class="submenu">
        <li><a href="#"><i class="fas fa-tools"></i> Installation</a></li>
        <li><a href="#"><i class="fas fa-hand-holding-usd"></i> Ventes</a></li>
        <li><a href="#"><i class="fas fa-file-invoice"></i> Devis</a></li>
        <li><a href="{% url 'demande_dimensionnement' %}"><i class="fas fa-bolt"></i> Dimensionnement</a></li>
      </ul>
    </li>

    <!-- Paramètres AVANT Utilisateur (mobile) -->
    {% if user.is_authenticated %}
      {% if user.is_superuser or user.role == "admin" %}
        <li>
          <a href="#" class="menu-link submenu-toggle">
            <span class="left"><i class="fas fa-cog"></i> <span class="label">Paramètres</span></span>
            <i class="fas fa-caret-down"></i>
          </a>
          <ul class="submenu">
            <li><a href="{% url 'user_list' %}"><i class="fas fa-users-cog"></i> Listes des utilisateurs</a></li>
            <li><a href="{% url 'produit_list' %}"><i class="fas fa-box"></i> Listes des Produits</a></li>
          </ul>
        </li>
      {% endif %}
    {% endif %}

    {% if user.is_authenticated %}
      <li>
        <a href="{% url 'logout' %}" class="menu-link">
          <span class="left"><i class="fas fa-sign-out-alt"></i> <span class="label">Déconnexion</span></span>
        </a>
      </li>
      <li>
        <a href="{% url 'profile' %}" class="menu-link">
          <span class="left"><i class="fas fa-tools"></i> <span class="label">Paramètres du compte</span></span>
        </a>
      </li>
    {% else %}
      <li><a href="{% url 'login' %}" class="menu-link"><span class="left"><i class="fas fa-sign-in-alt"></i> <span class="label">Connexion</span></span></a></li>
      <li><a href="{% url 'register' %}" class="menu-link"><span class="left"><i class="fas fa-user-plus"></i> <span class="label">Inscription</span></span></a></li>
    {% endif %}
  </ul>
</div>

<div id="sidebarOverlay"></div>

<script>
(function(){
  function onReady(fn){
    if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn,{once:true});}else{fn();}
  }

  onReady(function(){
    if(!window.bootstrap){ console.warn('Bootstrap JS non détecté.'); }

    // Tooltips & Dropdowns (desktop)
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el){ bootstrap && bootstrap.Tooltip.getOrCreateInstance(el); });
    document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(function(el){ bootstrap && bootstrap.Dropdown.getOrCreateInstance(el); });

    // Recherche (desktop)
    const searchIcon=document.getElementById('searchIcon');
    const searchDropdown=document.getElementById('searchDropdown');
    if(searchIcon && searchDropdown){
      searchIcon.addEventListener('click',function(e){
        e.preventDefault();
        const open=searchDropdown.style.display==='block';
        searchDropdown.style.display=open?'none':'block';
        if(!open){ const input=searchDropdown.querySelector('input'); input && input.focus(); }
      });
      document.addEventListener('click',function(e){
        if(e.target.closest('.dropdown-menu')||e.target.closest('[data-bs-toggle="dropdown"]')) return;
        if(!searchDropdown.contains(e.target) && !searchIcon.contains(e.target)){
          searchDropdown.style.display='none';
        }
      });
    }

    // Sidebar mobile
    const mobileBtn=document.getElementById('mobileMenuBtn');
    const mobileSidebar=document.getElementById('mobileSidebar');
    const overlay=document.getElementById('sidebarOverlay');
    const closeBtn=document.getElementById('closeSidebarBtn');
    if(mobileBtn && mobileSidebar && overlay && closeBtn){
      mobileBtn.addEventListener('click',()=>{ mobileSidebar.classList.add('active'); overlay.classList.add('active'); });
      overlay.addEventListener('click',()=>{ mobileSidebar.classList.remove('active'); overlay.classList.remove('active'); });
      closeBtn.addEventListener('click',()=>{ mobileSidebar.classList.remove('active'); overlay.classList.remove('active'); });
    }

    // Sous-menus mobile
    document.querySelectorAll('.submenu-toggle').forEach(function(t){
      t.addEventListener('click',function(e){
        e.preventDefault();
        const s=this.parentElement.querySelector('.submenu');
        if(s){ s.style.display = (s.style.display==='block') ? 'none' : 'block'; }
      });
    });
  });
})();
</script>
